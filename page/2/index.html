<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-TW">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="world4jason" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="菜鳥搬磚日常">
<meta property="og:type" content="website">
<meta property="og:title" content="world4jason">
<meta property="og:url" content="https://world4jason.github.io/page/2/index.html">
<meta property="og:site_name" content="world4jason">
<meta property="og:description" content="菜鳥搬磚日常">
<meta property="og:locale" content="zh-TW">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="world4jason">
<meta name="twitter:description" content="菜鳥搬磚日常">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://world4jason.github.io/page/2/"/>





  <title> world4jason </title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-TW">

  














  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">world4jason</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">菜鳥搬磚日常</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Startseite
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archiv
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://world4jason.github.io/2018/04/07/Resnet-Deep-Residual-Network/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jason Yeh">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="world4jason">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/04/07/Resnet-Deep-Residual-Network/" itemprop="url">
                  Deep Residual Network
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-07T21:15:01+08:00">
                2018-04-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Model-Architecture/" itemprop="url" rel="index">
                    <span itemprop="name">Model Architecture</span>
                  </a>
                </span>

                
                
                  . 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Model-Architecture/Classification/" itemprop="url" rel="index">
                    <span itemprop="name">Classification</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://world4jason.github.io/2018/04/07/Model-Compression/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jason Yeh">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="world4jason">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/04/07/Model-Compression/" itemprop="url">
                  CNN模型壓縮系列
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-07T21:05:01+08:00">
                2018-04-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Model-Architecture/" itemprop="url" rel="index">
                    <span itemprop="name">Model Architecture</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="網絡修剪"><a href="#網絡修剪" class="headerlink" title="網絡修剪"></a>網絡修剪</h2><p>網絡修剪，採用當網絡權重非常小的時候（小於某個設定的閾值），把它置0，就像二值網絡一般;然後屏蔽被設置為0的權重更新，繼續進行訓練;以此循環，每隔訓練幾輪過後，繼續進行修剪。<br>例如Deep-Compression這篇paper</p>
<h2 id="權重共享"><a href="#權重共享" class="headerlink" title="權重共享"></a>權重共享</h2><p>對於每一層的參數，我們進行k-均值聚類，進行量化，對於歸屬於同一個聚類中心的權重，採用共享一個權重，進行重新訓練。需要注意的是這個權重共享並不是層之間的權重共享，這是對於每一層的單獨共享</p>
<h2 id="增加L2權重"><a href="#增加L2權重" class="headerlink" title="增加L2權重"></a>增加L2權重</h2><p>增加L2權重可以讓更多的權重，靠近0，這樣每次修剪的比例大大增加。</p>
<h2 id="從結構上，簡化網絡計算，"><a href="#從結構上，簡化網絡計算，" class="headerlink" title="從結構上，簡化網絡計算，"></a>從結構上，簡化網絡計算，</h2><p>這些需要自己閱讀比較多相關文獻，才能設計出合理，速度更快的網絡，比如引入消防模塊，NIN，除全連接層等一些設計思想，這邊不進行具體詳述。<br>SqueezeNet</p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>Huffman Coding</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://world4jason.github.io/2018/04/07/VGG-VERY-DEEP-CONVOLUTIONAL-NETWORK-SFOR-LARGE-SCALE-IMAGE-RECOGNITION/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jason Yeh">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="world4jason">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/04/07/VGG-VERY-DEEP-CONVOLUTIONAL-NETWORK-SFOR-LARGE-SCALE-IMAGE-RECOGNITION/" itemprop="url">
                  VGG-VERY DEEP CONVOLUTIONAL NETWORK SFOR LARGE-SCALE IMAGE RECOGNITION
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-07T21:05:01+08:00">
                2018-04-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Model-Architecture/" itemprop="url" rel="index">
                    <span itemprop="name">Model Architecture</span>
                  </a>
                </span>

                
                
                  . 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Model-Architecture/Classification/" itemprop="url" rel="index">
                    <span itemprop="name">Classification</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>這篇的摘要寫說針對AlexNet的基礎上主要做了兩方面的改進：<br>1.使用了最小的3x3卷積核尺寸和最小間隔。</p>
<ol>
<li>在整個圖片和multi-scale上訓練和測試圖片。<br>論文原句：1. Use smaller receptive window size and smaller stride of the first convolutional layer.<br>2.Training and testing the networks densely over the whole image and over multiple scales.</li>
</ol>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">AlexNet做改進, 所以VGG本身的問題並不會在這篇討論, 會在ResNet那篇再探討。</div></pre></td></tr></table></figure>
<p><img src="/media/15231088858941.jpg" alt=""></p>
<p><img src="/media/15231088789196.jpg" alt=""></p>
<h2 id="架構"><a href="#架構" class="headerlink" title="架構"></a>架構</h2><p><img src="/media/15231067749133.jpg" alt=""><br><img src="/media/15231137520393.jpg" alt=""></p>
<p>採用較小的Filter尺寸-3x3，卷積的間隔s=1:<br>1：3x3是最小的能夠捕獲上下左右和中心概念的尺寸。<br>2：兩個3x3的捲基層的有限感受野是5x5；三個3x3的感受野是7x7，可以替代大的filter尺寸。<br>3：多個3x3的捲基層比一個大尺寸filter卷基層有更多的非線性，使得判決函數更加具有判決性。<br>4：多個3x3的捲積層比一個大尺寸的filter有更少的參數，假設卷基層的輸入和輸出的特徵圖大小相同為C，那麼三個3x3的捲積層參數個數3x（3x3xCxC）=27CC；一個7x7的捲積層參數為49CC；所以可以把三個3x3的filter看成是一個7x7filter的分解（中間層有非線性的分解）。<br>也使用過1x1 filter:<br>作用是在不影響輸入輸出維數的情況下，對輸入進行線性形變，然後通過Relu進行非線性處理，增加網絡的非線性表達能力。<br>Max-Pooling：2x2，間隔s=2；</p>
<p>論文中解釋關於僅使用3x3 conv kernel，因為兩個3x3的conv kernel疊合的reception field等效於一個5x5 conv kernel(亦即每個pixel可以correlate到周圍的5x5個pixel), 而三個3x3則可以等效於一個7x7，但兩層3x3的參數量僅有一層5x5的(3x3x2)/(5x5) = 0.72倍，而三層3x3參數量是一層7x7的(3x3x3)/(7x7)=0.55倍，對應到的範圍等效並且可使得需參數量更少，並且疊越多層Conv+ReLU的特徵學習能力比單一層Conv+ReLU來的更好。<br><img src="/media/15231135640564.jpg" alt=""></p>
<ol>
<li>Filter Size<br>相對於AlexNet 每個Stage僅含有一個Conv層, Filter 7x7, VGG每個Stage有2~4個Conv層,而Filter只有3x3, 原論文內”This can be seen as imposing a regularization on the 7 × 7 conv. filters, forcing them to have a decomposition through the 3 × 3 filters”<br>他說7x7 filter可以被分解成若干个3x3的filter的叠加。<br>類比一下n維空間的向量x，x的正交分解<br>x = x1(1, 0, 0, ….) + x2(0, 1, 0, …) + x3(0, 0, 1,…) + … + xn(0, 0, 0, …, 1)</li>
</ol>
<p>每一組的每一層的filter被類比成n維歐幾里得空間的基底。<br>若VGG的一組含有3層3x3的filter，則我們則假設一個7x7的filter可以被分解成3種“正交”的3x3的filter。</p>
<p>作者原文：First, we incorporate three non-linearrectification layers instead of a single one, which makes the decision function more discriminative.Second, we decrease the number of parameters: assuming that both the input and the output of athree-layer 3 × 3 convolution stack has C channels, the stack is parametrised by 3 32C^2 = 27C^2weights; at the same time, a single 7 × 7 conv. layer would require 72C^2 = 49C^2</p>
<p>後來googleNet<br>將3×3的卷積分解成31和13的卷積，可以減少33％的計算量，如果將3×3分解為兩個2×2的，可以減少11％的計算量，而且利用非對稱卷積的效果還更好。<br>實踐表明，不要過早的使用這種分解操作，在特徵映射大小為（12〜20）之間，使用它，效果是比較好的。 <img src="/media/15231135906645.jpg" alt=""></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://world4jason.github.io/2018/03/16/Light Head R-CNN/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jason Yeh">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="world4jason">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/03/16/Light Head R-CNN/" itemprop="url">
                  Light Head R-CNN
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-03-16T13:53:47+08:00">
                2018-03-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="/media/%E6%97%B7%E8%A7%86face++%E7%A0%94%E7%A9%B6%E9%99%A2%E8%A7%A3%E8%AF%BBLight-Head%20R-CNN.mp4">旷视face++研究院解读Light-Head R-CNN</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://world4jason.github.io/2018/03/16/2018-03-27/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jason Yeh">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="world4jason">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/03/16/2018-03-27/" itemprop="url">
                  Instance Segmentation Series
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-03-16T13:53:47+08:00">
                2018-03-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Series/" itemprop="url" rel="index">
                    <span itemprop="name">Series</span>
                  </a>
                </span>

                
                
                  . 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Series/Segmentation/" itemprop="url" rel="index">
                    <span itemprop="name">Segmentation</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>MNC<br>FCIS<br>Mask R-CNN<br>PANet</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://world4jason.github.io/2018/03/16/Tensorflow-Function-Usage-And-Example/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jason Yeh">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="world4jason">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/03/16/Tensorflow-Function-Usage-And-Example/" itemprop="url">
                  Tensorflow Function Usage And Example
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-03-16T13:53:47+08:00">
                2018-03-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Mini Tensorflow example<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</div><div class="line"> a = tf.placeholder(<span class="string">"float"</span>)</div><div class="line"> b = tf.placeholder(<span class="string">"float"</span>)</div><div class="line"></div><div class="line"> y = tf.mul(a, b) </div><div class="line"> sess = tf.Session()</div><div class="line"><span class="keyword">print</span> sess.run(y, feed_dict=&#123;a: <span class="number">3</span>, b: <span class="number">3</span>&#125;)</div><div class="line"> sess.close()</div></pre></td></tr></table></figure></p>
<table>
<thead>
<tr>
<th>操作組</th>
<th>操作</th>
</tr>
</thead>
<tbody>
<tr>
<td>Maths</td>
<td>Add, Sub, Mul, Div, Exp, Log, Greater, Less, Equal</td>
</tr>
<tr>
<td>Array</td>
<td>Concat, Slice, Split, Constant, Rank, Shape, Shuffle</td>
</tr>
<tr>
<td>Matrix</td>
<td>MatMul, MatrixInverse, MatrixDeterminant</td>
</tr>
<tr>
<td>Neuronal Network</td>
<td>SoftMax, Sigmoid, ReLU, Convolution2D, MaxPool</td>
</tr>
<tr>
<td>Checkpointing</td>
<td>Save, Restore</td>
</tr>
<tr>
<td>Queues and syncronizations</td>
<td>Enqueue, Dequeue, MutexAcquire, MutexRelease</td>
</tr>
<tr>
<td>Flow control</td>
<td>Merge, Switch, Enter, Leave, NextIteration</td>
</tr>
</tbody>
</table>
<p>TensorFlow的算術操作如下：</p>
<table>
<thead>
<tr>
<th>操作組</th>
<th>操作</th>
</tr>
</thead>
<tbody>
<tr>
<td>tf.add(x, y, name=None)</td>
<td>求和</td>
</tr>
<tr>
<td>tf.sub(x, y, name=None)</td>
<td>減法</td>
</tr>
<tr>
<td>tf.mul(x, y, name=None)</td>
<td>乘法</td>
</tr>
<tr>
<td>tf.div(x, y, name=None)</td>
<td>除法</td>
</tr>
<tr>
<td>tf.mod(x, y, name=None)</td>
<td>取模</td>
</tr>
<tr>
<td>tf.abs(x, name=None)</td>
<td>求絕對值</td>
</tr>
<tr>
<td>tf.neg(x, name=None)</td>
<td>取負 (y = -x).</td>
</tr>
<tr>
<td>tf.sign(x, name=None)</td>
<td>返回符號 y = sign(x) = -1 if x &lt; 0; 0 if x == 0; 1 if x &gt; 0.</td>
</tr>
<tr>
<td>tf.inv(x, name=None)</td>
<td>取反</td>
</tr>
<tr>
<td>tf.square(x, name=None)</td>
<td>計算平方 (y = x * x = x^2).</td>
</tr>
<tr>
<td>tf.round(x, name=None)</td>
<td>舍入最接近的整數      <br># ‘a’ is [0.9, 2.5, 2.3, -4.4]       <br> tf.round(a) ==&gt; [ 1.0, 3.0, 2.0, -4.0 ]</td>
</tr>
<tr>
<td>tf.sqrt(x, name=None)</td>
<td><br>開根號 (y = \sqrt{x} = x^{1/2}).</td>
</tr>
<tr>
<td>tf.pow(x, y, name=None)</td>
<td>冪次方                                                     <br># tensor ‘x’ is [[2, 2], [3, 3]]          <br># tensor ‘y’ is [[8, 16], [2, 3]] <br>tf.pow(x, y) ==&gt; [[256, 65536], [9, 27]]</td>
<td></td>
</tr>
<tr>
<td>tf.exp(x, name=None)</td>
<td>計算e的次方</td>
</tr>
<tr>
<td>tf.log(x, name=None)</td>
<td>計算log，一個輸入計算e的ln，兩輸入以第二輸入為底</td>
</tr>
<tr>
<td>tf.maximum(x, y, name=None)</td>
<td>返回最大值 (x &gt; y ? x : y)</td>
</tr>
<tr>
<td>tf.minimum(x, y, name=None)</td>
<td>返回最小值 (x &lt; y ? x : y)</td>
</tr>
<tr>
<td>tf.cos(x, name=None)</td>
<td>三角函數cosine</td>
</tr>
<tr>
<td>tf.sin(x, name=None)</td>
<td>三角函數sine</td>
</tr>
<tr>
<td>tf.tan(x, name=None)</td>
<td>三角函數tan</td>
</tr>
<tr>
<td>tf.atan(x, name=None)</td>
<td>三角函數ctan</td>
</tr>
</tbody>
</table>
<h2 id="張量操作Tensor-Transformations"><a href="#張量操作Tensor-Transformations" class="headerlink" title="張量操作Tensor Transformations"></a>張量操作Tensor Transformations</h2><p>####數據類型轉換Casting<br>| 操作組                        | 操作       |<br>|—————————-|——————————————————|<br>| tf.string_to_number                              |                      |<br>| (string_tensor, out_type=None, name=None)        | 字符串轉為數字              |<br>| tf.to_double(x, name=’ToDouble’)                 | 轉為64位浮點類型–float64    |<br>| tf.to_float(x, name=’ToFloat’)                   | 轉為32位浮點類型–float32    |<br>| tf.to_int32(x, name=’ToInt32’)                   | 轉為32位整型–int32        |<br>| tf.to_int64(x, name=’ToInt64’)                   | 轉為64位整型–int64        |<br>| tf.cast(x, dtype, name=None)                     | 將x或者x.values轉換為dtype |<br>| # tensor a is [1.8, 2.2], dtype=tf.float         |                      |<br>| tf.cast(a, tf.int32) ==&gt; [1, 2] # dtype=tf.int32 |                      | </p>
<h4 id="形狀操作Shapes-and-Shaping"><a href="#形狀操作Shapes-and-Shaping" class="headerlink" title="形狀操作Shapes and Shaping"></a>形狀操作Shapes and Shaping</h4><table>
<thead>
<tr>
<th>操作組</th>
<th>操作</th>
</tr>
</thead>
<tbody>
<tr>
<td>tf.shape(input, name=None)</td>
<td>返回數據的shape       <br> # ‘t’ is [[[1, 1, 1], [2, 2, 2]], [[3, 3, 3], [4, 4, 4]]]  <br> shape(t) ==&gt; [2, 2, 3]</td>
<td></td>
</tr>
<tr>
<td>tf.size(input, name=None)</td>
<td>返回數據的元素數量 <br> # ‘t’ is [[[1, 1, 1], [2, 2, 2]], [[3, 3, 3], [4, 4, 4]]]]  <br> size(t) ==&gt; 12</td>
<td></td>
</tr>
<tr>
<td>tf.rank(input, name=None)</td>
<td>返回tensor的rank    <br> 注意：此rank不同於矩陣的rank， <br> tensor的rank表示一個tensor需要的索引數目來唯一表示任何一個元素 <br> 也就是通常所説的 “order”, “degree”或”ndims”   <br> #’t’ is [[[1, 1, 1], [2, 2, 2]], [[3, 3, 3], [4, 4, 4]]]  <br> # shape of tensor ‘t’ is [2, 2, 3]                          <br> rank(t) ==&gt; 3</td>
<td></td>
</tr>
<tr>
<td>tf.reshape(tensor, shape, name=None)</td>
<td>改變tensor的形狀      <br> # tensor ‘t’ is [1, 2, 3, 4, 5, 6, 7, 8, 9] <br> # tensor ‘t’ has shape [9]   <br> reshape(t, [3, 3]) ==&gt;                                      <br> [[1, 2, 3],                                                 <br> [4, 5, 6],                                                  <br> [7, 8, 9]]                                                  <br> #如果shape有元素[-1],表示在該維度打平至一維                                 <br> # -1 將自動推導得為 9:                                             <br> reshape(t, [2, -1]) ==&gt;                                     <br> [[1, 1, 1, 2, 2, 2, 3, 3, 3],                               <br> [4, 4, 4, 5, 5, 5, 6, 6, 6]]</td>
<td></td>
</tr>
<tr>
<td>tf.expand_dims(input, dim, name=None)</td>
<td>插入維度1進入一個tensor中 <br> #該操作要求-1-input.dims()                                       <br> # ‘t’ is a tensor of shape [2]                              <br> shape(expand_dims(t, 0)) ==&gt; [1, 2]                         <br> shape(expand_dims(t, 1)) ==&gt; [2, 1]                         <br>shape(expand_dims(t, -1)) ==&gt; [2, 1] &lt;= dim &lt;= input.dims()</td>
</tr>
</tbody>
</table>
<p><a href="https://hk.saowen.com/a/2766b13f38b54ab09e6d478975f5feca8abbf01d842e2ca8f5111160fcbb0e36" target="_blank" rel="external">https://hk.saowen.com/a/2766b13f38b54ab09e6d478975f5feca8abbf01d842e2ca8f5111160fcbb0e36</a></p>
<h3 id="tf-reshape"><a href="#tf-reshape" class="headerlink" title="tf.reshape"></a>tf.reshape</h3><p>tf.reshape(tensor,shape, name=None) </p>
<p>重組</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"># tensor </div><div class="line">'t' is [1, 2, 3, 4, 5, 6, 7, 8, 9]</div><div class="line"># tensor </div><div class="line">'t'has shape [9]</div><div class="line"></div><div class="line">reshape(t, [3, 3]) </div><div class="line">==&gt; </div><div class="line">[[1, 2, 3],</div><div class="line">[4, 5, 6],</div><div class="line">[7, 8, 9]]</div></pre></td></tr></table></figure>
<p>降為</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"># tensor </div><div class="line">'t'is </div><div class="line">[[[1, 1], [2, 2]],                </div><div class="line">[[3, 3], [4, 4]]]</div><div class="line"># tensor </div><div class="line">'t'has shape [2, 2, 2]</div><div class="line">reshape(t, [2, 4]) </div><div class="line">==&gt; </div><div class="line">[[1, 1, 2, 2],</div><div class="line">[3, 3, 4, 4]]</div></pre></td></tr></table></figure>
<p>平坦</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"># tensor </div><div class="line">'t' has shape [3, 2, 3]</div><div class="line"># pass </div><div class="line">'[-1]'</div><div class="line"> to flatten </div><div class="line">'t'</div><div class="line">reshape(t, [-1]) </div><div class="line">==&gt; [1, 1, 1, 2, 2, 2, 3, 3, 3, 4, 4, 4, 5, 5, 5, 6, 6, 6]</div></pre></td></tr></table></figure>
<h3 id="tf-split"><a href="#tf-split" class="headerlink" title="tf.split"></a>tf.split</h3><p>tf.split(split_dim, num_split, value, name=’split’)<br>將大的tensor分割成更小的tensor，第一個參數代表沿著那一維開始分割，第二個參數代表切成幾段</p>
<h3 id="tf-nn-max-pool"><a href="#tf-nn-max-pool" class="headerlink" title="tf.nn.max_pool"></a>tf.nn.max_pool</h3><p>max pooling 是CNN 當中的最大值池化操作，其實用法和卷積很類似</p>
<p>tf.nn.max_pool(value,ksize, strides, padding, name=None)</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">參數是四個，和卷積很類似：</div><div class="line"></div><div class="line">第一個參數value ：需要池化的輸入，一般池化層接在卷積層後面，所以輸入通常是<span class="built_in">feature</span> <span class="built_in">map</span> ，依然是[<span class="built_in">batch</span>, <span class="built_in">height</span>, <span class="built_in">width</span>, channels] 這樣的shape</div><div class="line"></div><div class="line">第二個參數ksize ：池化窗口的大小，取一個四維向量，一般是[<span class="number">1</span>, <span class="built_in">height</span>, <span class="built_in">width</span>, <span class="number">1</span>] ，因為我們不想在<span class="built_in">batch</span> 和channels 上做池化，所以這兩個維度設為了<span class="number">1</span></div><div class="line"></div><div class="line">第三個參數strides ：和卷積類似，窗口在每一個維度上滑動的步長，一般也是[<span class="number">1</span>, stride, stride ,<span class="number">1</span>]</div><div class="line"></div><div class="line">第四個參數padding ：和卷積類似，可以取'VALID' 或者'SAME'</div><div class="line">返回一個Tensor ，類型不變，shape 仍然是[<span class="built_in">batch</span>, <span class="built_in">height</span>, <span class="built_in">width</span>, channels] 這種形式</div></pre></td></tr></table></figure>
<p>假設有這樣一張圖，雙通道<br>第一個通道：<br><img src="/media/15225714198554.jpg" alt=""><br>第二個通道：<br><img src="/media/15225714248800.jpg" alt=""></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</div><div class="line"></div><div class="line">a=tf.constant([</div><div class="line"></div><div class="line">        [[<span class="number">1.0</span>,<span class="number">2.0</span>,<span class="number">3.0</span>,<span class="number">4.0</span>],</div><div class="line"></div><div class="line">       [<span class="number">5.0</span>,<span class="number">6.0</span>,<span class="number">7.0</span>,<span class="number">8.0</span>],</div><div class="line"></div><div class="line">       [<span class="number">8.0</span>,<span class="number">7.0</span>,<span class="number">6.0</span>,<span class="number">5.0</span>],</div><div class="line"></div><div class="line">       [<span class="number">4.0</span>,<span class="number">3.0</span>,<span class="number">2.0</span>,<span class="number">1.0</span>]],</div><div class="line"></div><div class="line">       [[<span class="number">4.0</span>,<span class="number">3.0</span>,<span class="number">2.0</span>,<span class="number">1.0</span>],</div><div class="line"></div><div class="line">        [<span class="number">8.0</span>,<span class="number">7.0</span>,<span class="number">6.0</span>,<span class="number">5.0</span>],</div><div class="line"></div><div class="line">        [<span class="number">1.0</span>,<span class="number">2.0</span>,<span class="number">3.0</span>,<span class="number">4.0</span>],</div><div class="line"></div><div class="line">        [<span class="number">5.0</span>,<span class="number">6.0</span>,<span class="number">7.0</span>,<span class="number">8.0</span>]]</div><div class="line"></div><div class="line">    ])</div><div class="line"></div><div class="line">a=tf.reshape(a,[<span class="number">1</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">2</span>])</div><div class="line">pooling=tf.nn.max_pool(a,[<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">1</span>],[<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>],padding=<span class="string">'VALID'</span>)</div><div class="line"></div><div class="line"><span class="keyword">with</span> tf.Session() <span class="keyword">as</span> sess:</div><div class="line">   print(<span class="string">"image:"</span>)</div><div class="line">   image=sess.run(a)</div><div class="line">   <span class="keyword">print</span> (image)</div><div class="line">   print(<span class="string">"reslut:"</span>)</div><div class="line">   result=sess.run(pooling)</div><div class="line">   <span class="keyword">print</span> (result)</div></pre></td></tr></table></figure>
<p>這裡步長為1 ，窗口大小2×2 ，輸出結果：</p>
<p>image:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">[[</div><div class="line">[[ <span class="number">1.</span> <span class="number">2.</span>]</div><div class="line">[ <span class="number">3.</span> <span class="number">4.</span>]</div><div class="line">[ <span class="number">5.</span> <span class="number">6.</span>]</div><div class="line">[ <span class="number">7.</span> <span class="number">8.</span>]]</div><div class="line"></div><div class="line">[[ <span class="number">8.</span> <span class="number">7.</span>]</div><div class="line">[ <span class="number">6.</span> <span class="number">5.</span>]</div><div class="line">[ <span class="number">4.</span> <span class="number">3.</span>]</div><div class="line">[ <span class="number">2.</span> <span class="number">1.</span>]]</div><div class="line"></div><div class="line">[[ <span class="number">4.</span> <span class="number">3.</span>]</div><div class="line">[ <span class="number">2.</span> <span class="number">1.</span>]</div><div class="line">[ <span class="number">8.</span> <span class="number">7.</span>]</div><div class="line">[ <span class="number">6.</span> <span class="number">5.</span>]]</div><div class="line"></div><div class="line">[[ <span class="number">1.</span> <span class="number">2.</span>]</div><div class="line">[ <span class="number">3.</span> <span class="number">4.</span>]</div><div class="line">[ <span class="number">5.</span> <span class="number">6.</span>]</div><div class="line">[ <span class="number">7.</span> <span class="number">8.</span>]]]]</div><div class="line"></div><div class="line">reslut:</div><div class="line"></div><div class="line">[[</div><div class="line">[[ <span class="number">8.</span> <span class="number">7.</span>]</div><div class="line">[ <span class="number">6.</span> <span class="number">6.</span>]</div><div class="line">[ <span class="number">7.</span> <span class="number">8.</span>]]</div><div class="line"></div><div class="line">[[ <span class="number">8.</span> <span class="number">7.</span>]</div><div class="line">[ <span class="number">8.</span> <span class="number">7.</span>]</div><div class="line">[ <span class="number">8.</span> <span class="number">7.</span>]]</div><div class="line"></div><div class="line">[[ <span class="number">4.</span> <span class="number">4.</span>]</div><div class="line">[ <span class="number">8.</span> <span class="number">7.</span>]</div><div class="line">[ <span class="number">8.</span> <span class="number">8.</span>]]]]</div></pre></td></tr></table></figure>
<p>池化後的圖就是：</p>
<p><img src="/media/15225714762104.jpg" alt=""></p>
<p><img src="/media/15225714795456.jpg" alt=""></p>
<p>證明了程序的結果是正確的。<br>我們還可以改變步長</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">pooling=tf.nn.max_pool(a,[<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">1</span>],[<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">1</span>],padding=<span class="string">'VALID'</span>)</div><div class="line"></div><div class="line">最後的result 就變成：</div><div class="line"></div><div class="line">reslut:</div><div class="line">[[[[ <span class="number">8.</span> <span class="number">7.</span>]</div><div class="line">[ <span class="number">7.</span> <span class="number">8.</span>]]</div><div class="line">[[ <span class="number">4.</span> <span class="number">4.</span>]</div><div class="line">[ <span class="number">8.</span> <span class="number">8.</span>]]]]</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://world4jason.github.io/2018/03/10/Mask R-CNN/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jason Yeh">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="world4jason">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/03/10/Mask R-CNN/" itemprop="url">
                  Mask R-CNN
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-03-10T02:13:59+08:00">
                2018-03-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Segmentation/" itemprop="url" rel="index">
                    <span itemprop="name">Segmentation</span>
                  </a>
                </span>

                
                
                  . 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Segmentation/Detection/" itemprop="url" rel="index">
                    <span itemprop="name">Detection</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><p><img src="/media/15222419162572.jpg" alt=""></p>
<p><img src="/media/15144439857026.jpg" alt=""></p>
<h2 id="Concept"><a href="#Concept" class="headerlink" title="Concept"></a>Concept</h2><p>Mask R-CNN 利用了相當簡潔與彈性的方法進行實例分割, 主要跟 Faster R-CNN 不同的地方在於原架構有 2 個分支 </p>
<ol>
<li>Classification branch </li>
<li>Bounding box branch </li>
</ol>
<p>而 Mask R-CNN 的方法則是多加了另一個分支  — Mask branch。</p>
<h2 id="Mask-branch"><a href="#Mask-branch" class="headerlink" title="Mask branch"></a>Mask branch</h2><h2 id="Loss-function"><a href="#Loss-function" class="headerlink" title="Loss function"></a>Loss function</h2><p>L<sub>total</sub> = L<sub>cls</sub> + L<sub>box</sub>  + L<sub>mask</sub> </p>
<p>L<sub>cls</sub> 跟 L<sub>box</sub>的可以參考Fast-RCNN</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">J<span class="comment">(θ)</span>=−<span class="number">1</span>m[∑mi=<span class="number">1</span>y<span class="comment">(i)</span>loghθ<span class="comment">(x(i)</span>)+<span class="comment">(1−y(i)</span>)log<span class="comment">(1−hθ(x(i)</span>))]</div></pre></td></tr></table></figure>
<h2 id="ROI-Alignment"><a href="#ROI-Alignment" class="headerlink" title="ROI Alignment"></a>ROI Alignment</h2><h3 id="ROI-POOLING"><a href="#ROI-POOLING" class="headerlink" title="ROI POOLING"></a>ROI POOLING</h3><p>ROI POOLING 概念如下圖所示<br><img src="/media/15137535435975.png" alt=""></p>
<p><img src="/media/15137536007979.gif" alt=""></p>
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">\m</span>athcal &#123;F_&#123;i&#125;^&#123;RoI&#125;&#125;_&#123;(u^<span class="symbol">\p</span>rime,v^<span class="symbol">\p</span>rime)&#125; = <span class="symbol">\s</span>um_&#123;(u,v)&#125;^&#123;W <span class="symbol">\t</span>imes H&#125; G(u,v;u^<span class="symbol">\p</span>rime, v^<span class="symbol">\p</span>rime|B_i) <span class="symbol">\m</span>athcal F_(u,v)</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://world4jason.github.io/2018/03/10/Mask R-CNN Code Reading/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jason Yeh">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="world4jason">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/03/10/Mask R-CNN Code Reading/" itemprop="url">
                  Mask R-CNN
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-03-10T02:13:59+08:00">
                2018-03-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Segmentation/" itemprop="url" rel="index">
                    <span itemprop="name">Segmentation</span>
                  </a>
                </span>

                
                
                  . 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Segmentation/Detection/" itemprop="url" rel="index">
                    <span itemprop="name">Detection</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://github.com/matterport/Mask_RCNN" target="_blank" rel="external">https://github.com/matterport/Mask_RCNN</a></p>
<p>#model.py</p>
<ol>
<li>import 需要的東西 tf ver&gt;1.3 &amp;&amp; keras ver&gt;2.0.8</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> sys</div><div class="line"><span class="keyword">import</span> glob</div><div class="line"><span class="keyword">import</span> random</div><div class="line"><span class="keyword">import</span> math</div><div class="line"><span class="keyword">import</span> datetime</div><div class="line"><span class="keyword">import</span> itertools</div><div class="line"><span class="keyword">import</span> json</div><div class="line"><span class="keyword">import</span> re</div><div class="line"><span class="keyword">import</span> logging</div><div class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> OrderedDict</div><div class="line"><span class="keyword">import</span> multiprocessing</div><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"><span class="keyword">import</span> skimage.transform</div><div class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</div><div class="line"><span class="keyword">import</span> keras</div><div class="line"><span class="keyword">import</span> keras.backend <span class="keyword">as</span> K</div><div class="line"><span class="keyword">import</span> keras.layers <span class="keyword">as</span> KL</div><div class="line"><span class="keyword">import</span> keras.initializers <span class="keyword">as</span> KI</div><div class="line"><span class="keyword">import</span> keras.engine <span class="keyword">as</span> KE</div><div class="line"><span class="keyword">import</span> keras.models <span class="keyword">as</span> KM</div><div class="line"></div><div class="line"><span class="keyword">import</span> utils</div><div class="line"></div><div class="line"><span class="comment"># Requires TensorFlow 1.3+ and Keras 2.0.8+.</span></div><div class="line"><span class="keyword">from</span> distutils.version <span class="keyword">import</span> LooseVersion</div><div class="line"><span class="keyword">assert</span> LooseVersion(tf.__version__) &gt;= LooseVersion(<span class="string">"1.3"</span>)</div><div class="line"><span class="keyword">assert</span> LooseVersion(keras.__version__) &gt;= LooseVersion(<span class="string">'2.0.8'</span>)</div></pre></td></tr></table></figure>
<ol>
<li>封裝Mask R-CNN </li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div><div class="line">429</div><div class="line">430</div><div class="line">431</div><div class="line">432</div><div class="line">433</div><div class="line">434</div><div class="line">435</div><div class="line">436</div><div class="line">437</div><div class="line">438</div><div class="line">439</div><div class="line">440</div><div class="line">441</div><div class="line">442</div><div class="line">443</div><div class="line">444</div><div class="line">445</div><div class="line">446</div><div class="line">447</div><div class="line">448</div><div class="line">449</div><div class="line">450</div><div class="line">451</div><div class="line">452</div><div class="line">453</div><div class="line">454</div><div class="line">455</div><div class="line">456</div><div class="line">457</div><div class="line">458</div><div class="line">459</div><div class="line">460</div><div class="line">461</div><div class="line">462</div><div class="line">463</div><div class="line">464</div><div class="line">465</div><div class="line">466</div><div class="line">467</div><div class="line">468</div><div class="line">469</div><div class="line">470</div><div class="line">471</div><div class="line">472</div><div class="line">473</div><div class="line">474</div><div class="line">475</div><div class="line">476</div><div class="line">477</div><div class="line">478</div><div class="line">479</div><div class="line">480</div><div class="line">481</div><div class="line">482</div><div class="line">483</div><div class="line">484</div><div class="line">485</div><div class="line">486</div><div class="line">487</div><div class="line">488</div><div class="line">489</div><div class="line">490</div><div class="line">491</div><div class="line">492</div><div class="line">493</div><div class="line">494</div><div class="line">495</div><div class="line">496</div><div class="line">497</div><div class="line">498</div><div class="line">499</div><div class="line">500</div><div class="line">501</div><div class="line">502</div><div class="line">503</div><div class="line">504</div><div class="line">505</div><div class="line">506</div><div class="line">507</div><div class="line">508</div><div class="line">509</div><div class="line">510</div><div class="line">511</div><div class="line">512</div><div class="line">513</div><div class="line">514</div><div class="line">515</div><div class="line">516</div><div class="line">517</div><div class="line">518</div><div class="line">519</div><div class="line">520</div><div class="line">521</div><div class="line">522</div><div class="line">523</div><div class="line">524</div><div class="line">525</div><div class="line">526</div><div class="line">527</div><div class="line">528</div><div class="line">529</div><div class="line">530</div><div class="line">531</div><div class="line">532</div><div class="line">533</div><div class="line">534</div><div class="line">535</div><div class="line">536</div><div class="line">537</div><div class="line">538</div><div class="line">539</div><div class="line">540</div><div class="line">541</div><div class="line">542</div><div class="line">543</div><div class="line">544</div><div class="line">545</div><div class="line">546</div><div class="line">547</div><div class="line">548</div><div class="line">549</div><div class="line">550</div><div class="line">551</div><div class="line">552</div><div class="line">553</div><div class="line">554</div><div class="line">555</div><div class="line">556</div><div class="line">557</div><div class="line">558</div><div class="line">559</div><div class="line">560</div><div class="line">561</div><div class="line">562</div><div class="line">563</div><div class="line">564</div><div class="line">565</div><div class="line">566</div><div class="line">567</div><div class="line">568</div><div class="line">569</div><div class="line">570</div><div class="line">571</div><div class="line">572</div><div class="line">573</div><div class="line">574</div><div class="line">575</div><div class="line">576</div><div class="line">577</div><div class="line">578</div><div class="line">579</div><div class="line">580</div><div class="line">581</div><div class="line">582</div><div class="line">583</div><div class="line">584</div><div class="line">585</div><div class="line">586</div><div class="line">587</div><div class="line">588</div><div class="line">589</div><div class="line">590</div><div class="line">591</div><div class="line">592</div><div class="line">593</div><div class="line">594</div><div class="line">595</div><div class="line">596</div><div class="line">597</div><div class="line">598</div><div class="line">599</div><div class="line">600</div><div class="line">601</div><div class="line">602</div><div class="line">603</div><div class="line">604</div><div class="line">605</div><div class="line">606</div><div class="line">607</div><div class="line">608</div><div class="line">609</div><div class="line">610</div><div class="line">611</div><div class="line">612</div><div class="line">613</div><div class="line">614</div><div class="line">615</div><div class="line">616</div><div class="line">617</div><div class="line">618</div><div class="line">619</div><div class="line">620</div><div class="line">621</div><div class="line">622</div><div class="line">623</div><div class="line">624</div><div class="line">625</div><div class="line">626</div><div class="line">627</div><div class="line">628</div><div class="line">629</div><div class="line">630</div><div class="line">631</div><div class="line">632</div><div class="line">633</div><div class="line">634</div><div class="line">635</div><div class="line">636</div><div class="line">637</div><div class="line">638</div><div class="line">639</div><div class="line">640</div><div class="line">641</div><div class="line">642</div><div class="line">643</div><div class="line">644</div><div class="line">645</div><div class="line">646</div><div class="line">647</div><div class="line">648</div><div class="line">649</div><div class="line">650</div><div class="line">651</div><div class="line">652</div><div class="line">653</div><div class="line">654</div><div class="line">655</div><div class="line">656</div><div class="line">657</div><div class="line">658</div><div class="line">659</div><div class="line">660</div><div class="line">661</div><div class="line">662</div><div class="line">663</div><div class="line">664</div><div class="line">665</div><div class="line">666</div><div class="line">667</div><div class="line">668</div><div class="line">669</div><div class="line">670</div><div class="line">671</div><div class="line">672</div><div class="line">673</div><div class="line">674</div><div class="line">675</div><div class="line">676</div><div class="line">677</div><div class="line">678</div><div class="line">679</div><div class="line">680</div><div class="line">681</div><div class="line">682</div><div class="line">683</div><div class="line">684</div><div class="line">685</div><div class="line">686</div><div class="line">687</div><div class="line">688</div><div class="line">689</div><div class="line">690</div><div class="line">691</div><div class="line">692</div><div class="line">693</div><div class="line">694</div><div class="line">695</div><div class="line">696</div><div class="line">697</div><div class="line">698</div><div class="line">699</div><div class="line">700</div><div class="line">701</div><div class="line">702</div><div class="line">703</div><div class="line">704</div><div class="line">705</div><div class="line">706</div><div class="line">707</div><div class="line">708</div><div class="line">709</div><div class="line">710</div><div class="line">711</div><div class="line">712</div><div class="line">713</div><div class="line">714</div><div class="line">715</div><div class="line">716</div><div class="line">717</div><div class="line">718</div><div class="line">719</div><div class="line">720</div><div class="line">721</div><div class="line">722</div><div class="line">723</div><div class="line">724</div><div class="line">725</div><div class="line">726</div><div class="line">727</div><div class="line">728</div><div class="line">729</div><div class="line">730</div><div class="line">731</div><div class="line">732</div><div class="line">733</div><div class="line">734</div><div class="line">735</div><div class="line">736</div><div class="line">737</div><div class="line">738</div><div class="line">739</div><div class="line">740</div><div class="line">741</div><div class="line">742</div><div class="line">743</div><div class="line">744</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MaskRCNN</span><span class="params">()</span>:</span></div><div class="line">    <span class="string">"""Encapsulates the Mask RCNN model functionality.</span></div><div class="line"></div><div class="line">    The actual Keras model is in the keras_model property.</div><div class="line">    """</div><div class="line">    <span class="comment">## Config 設定是由外部傳入，像是ballon.py裡面有關於batch_size、Iteration等等，詳細內容去看config.py</span></div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, mode, config, model_dir)</span>:</span></div><div class="line">        <span class="string">"""</span></div><div class="line">        mode: Either "training" or "inference"</div><div class="line">        config: A Sub-class of the Config class</div><div class="line">        model_dir: Directory to save training logs and trained weights</div><div class="line">        """</div><div class="line">        <span class="keyword">assert</span> mode <span class="keyword">in</span> [<span class="string">'training'</span>, <span class="string">'inference'</span>]</div><div class="line">        self.mode = mode</div><div class="line">        self.config = config</div><div class="line">        self.model_dir = model_dir</div><div class="line">        self.set_log_dir()</div><div class="line">        self.keras_model = self.build(mode=mode, config=config)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">build</span><span class="params">(self, mode, config)</span>:</span></div><div class="line">        <span class="string">"""Build Mask R-CNN architecture.</span></div><div class="line">            input_shape: The shape of the input image.</div><div class="line">            mode: Either "training" or "inference". The inputs and</div><div class="line">                outputs of the model differ accordingly.</div><div class="line">        """</div><div class="line">        <span class="keyword">assert</span> mode <span class="keyword">in</span> [<span class="string">'training'</span>, <span class="string">'inference'</span>]</div><div class="line">        </div><div class="line">        <span class="comment"># 強迫要求一定要是 長寬一定要是32的倍數，不然downscaling跟upscaling會有問題</span></div><div class="line">        <span class="comment"># 尤其是convultion到後面Resnet是縮放了32倍</span></div><div class="line">        <span class="comment"># Image size must be dividable by 2 multiple times</span></div><div class="line">        h, w = config.IMAGE_SHAPE[:<span class="number">2</span>]</div><div class="line">        <span class="keyword">if</span> h / <span class="number">2</span>**<span class="number">6</span> != int(h / <span class="number">2</span>**<span class="number">6</span>) <span class="keyword">or</span> w / <span class="number">2</span>**<span class="number">6</span> != int(w / <span class="number">2</span>**<span class="number">6</span>):</div><div class="line">            <span class="keyword">raise</span> Exception(<span class="string">"Image size must be dividable by 2 at least 6 times "</span></div><div class="line">                            <span class="string">"to avoid fractions when downscaling and upscaling."</span></div><div class="line">                            <span class="string">"For example, use 256, 320, 384, 448, 512, ... etc. "</span>)</div><div class="line">        </div><div class="line">        <span class="comment"># config.IMAGE_SHAPE.tolist() = [1024,1024,3]</span></div><div class="line">        <span class="comment"># input_image_meta有點意義不明</span></div><div class="line">        <span class="comment"># 此段落是建立需要的輸入，都用KL.Input來轉化</span></div><div class="line">        <span class="comment"># Inputs</span></div><div class="line">        input_image = KL.Input(</div><div class="line">            shape=config.IMAGE_SHAPE.tolist(), name=<span class="string">"input_image"</span>)</div><div class="line">        input_image_meta = KL.Input(shape=[<span class="keyword">None</span>], name=<span class="string">"input_image_meta"</span>)</div><div class="line">        <span class="keyword">if</span> mode == <span class="string">"training"</span>:</div><div class="line">            <span class="comment"># RPN GT</span></div><div class="line">            input_rpn_match = KL.Input(</div><div class="line">                shape=[<span class="keyword">None</span>, <span class="number">1</span>], name=<span class="string">"input_rpn_match"</span>, dtype=tf.int32)</div><div class="line">            input_rpn_bbox = KL.Input(</div><div class="line">                shape=[<span class="keyword">None</span>, <span class="number">4</span>], name=<span class="string">"input_rpn_bbox"</span>, dtype=tf.float32)</div><div class="line"></div><div class="line">            <span class="comment"># Detection GT (class IDs, bounding boxes, and masks)</span></div><div class="line">            <span class="comment"># 1. GT Class IDs (zero padded)</span></div><div class="line">            input_gt_class_ids = KL.Input(</div><div class="line">                shape=[<span class="keyword">None</span>], name=<span class="string">"input_gt_class_ids"</span>, dtype=tf.int32)</div><div class="line">            <span class="comment"># 2. GT Boxes in pixels (zero padded)</span></div><div class="line">            <span class="comment"># [batch, MAX_GT_INSTANCES, (y1, x1, y2, x2)] in image coordinates</span></div><div class="line">            input_gt_boxes = KL.Input(</div><div class="line">                shape=[<span class="keyword">None</span>, <span class="number">4</span>], name=<span class="string">"input_gt_boxes"</span>, dtype=tf.float32)</div><div class="line">            <span class="comment"># Normalize coordinates</span></div><div class="line">            h, w = K.shape(input_image)[<span class="number">1</span>], K.shape(input_image)[<span class="number">2</span>]</div><div class="line">            image_scale = K.cast(K.stack([h, w, h, w], axis=<span class="number">0</span>), tf.float32)</div><div class="line">            gt_boxes = KL.Lambda(<span class="keyword">lambda</span> x: x / image_scale)(input_gt_boxes)</div><div class="line">            <span class="comment"># 3. GT Masks (zero padded)</span></div><div class="line">            <span class="comment"># [batch, height, width, MAX_GT_INSTANCES]</span></div><div class="line">            <span class="keyword">if</span> config.USE_MINI_MASK:</div><div class="line">                input_gt_masks = KL.Input(</div><div class="line">                    shape=[config.MINI_MASK_SHAPE[<span class="number">0</span>],</div><div class="line">                           config.MINI_MASK_SHAPE[<span class="number">1</span>], <span class="keyword">None</span>],</div><div class="line">                    name=<span class="string">"input_gt_masks"</span>, dtype=bool)</div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                input_gt_masks = KL.Input(</div><div class="line">                    shape=[config.IMAGE_SHAPE[<span class="number">0</span>], config.IMAGE_SHAPE[<span class="number">1</span>], <span class="keyword">None</span>],</div><div class="line">                    name=<span class="string">"input_gt_masks"</span>, dtype=bool)</div><div class="line"></div><div class="line">        <span class="comment"># Build the shared convolutional layers.</span></div><div class="line">        <span class="comment"># Bottom-up Layers</span></div><div class="line">        <span class="comment"># Returns a list of the last layers of each stage, 5 in total.</span></div><div class="line">        <span class="comment"># Don't create the thead (stage 5), so we pick the 4th item in the list.</span></div><div class="line">        _, C2, C3, C4, C5 = resnet_graph(input_image, config.BACKBONE, stage5=<span class="keyword">True</span>)</div><div class="line">        <span class="comment"># Top-down Layers</span></div><div class="line">        <span class="comment"># <span class="doctag">TODO:</span> add assert to varify feature map sizes match what's in config</span></div><div class="line">        P5 = KL.Conv2D(<span class="number">256</span>, (<span class="number">1</span>, <span class="number">1</span>), name=<span class="string">'fpn_c5p5'</span>)(C5)</div><div class="line">        P4 = KL.Add(name=<span class="string">"fpn_p4add"</span>)([</div><div class="line">            KL.UpSampling2D(size=(<span class="number">2</span>, <span class="number">2</span>), name=<span class="string">"fpn_p5upsampled"</span>)(P5),</div><div class="line">            KL.Conv2D(<span class="number">256</span>, (<span class="number">1</span>, <span class="number">1</span>), name=<span class="string">'fpn_c4p4'</span>)(C4)])</div><div class="line">        P3 = KL.Add(name=<span class="string">"fpn_p3add"</span>)([</div><div class="line">            KL.UpSampling2D(size=(<span class="number">2</span>, <span class="number">2</span>), name=<span class="string">"fpn_p4upsampled"</span>)(P4),</div><div class="line">            KL.Conv2D(<span class="number">256</span>, (<span class="number">1</span>, <span class="number">1</span>), name=<span class="string">'fpn_c3p3'</span>)(C3)])</div><div class="line">        P2 = KL.Add(name=<span class="string">"fpn_p2add"</span>)([</div><div class="line">            KL.UpSampling2D(size=(<span class="number">2</span>, <span class="number">2</span>), name=<span class="string">"fpn_p3upsampled"</span>)(P3),</div><div class="line">            KL.Conv2D(<span class="number">256</span>, (<span class="number">1</span>, <span class="number">1</span>), name=<span class="string">'fpn_c2p2'</span>)(C2)])</div><div class="line">        <span class="comment"># Attach 3x3 conv to all P layers to get the final feature maps.</span></div><div class="line">        P2 = KL.Conv2D(<span class="number">256</span>, (<span class="number">3</span>, <span class="number">3</span>), padding=<span class="string">"SAME"</span>, name=<span class="string">"fpn_p2"</span>)(P2)</div><div class="line">        P3 = KL.Conv2D(<span class="number">256</span>, (<span class="number">3</span>, <span class="number">3</span>), padding=<span class="string">"SAME"</span>, name=<span class="string">"fpn_p3"</span>)(P3)</div><div class="line">        P4 = KL.Conv2D(<span class="number">256</span>, (<span class="number">3</span>, <span class="number">3</span>), padding=<span class="string">"SAME"</span>, name=<span class="string">"fpn_p4"</span>)(P4)</div><div class="line">        P5 = KL.Conv2D(<span class="number">256</span>, (<span class="number">3</span>, <span class="number">3</span>), padding=<span class="string">"SAME"</span>, name=<span class="string">"fpn_p5"</span>)(P5)</div><div class="line">        <span class="comment"># P6 is used for the 5th anchor scale in RPN. Generated by</span></div><div class="line">        <span class="comment"># subsampling from P5 with stride of 2.</span></div><div class="line">        P6 = KL.MaxPooling2D(pool_size=(<span class="number">1</span>, <span class="number">1</span>), strides=<span class="number">2</span>, name=<span class="string">"fpn_p6"</span>)(P5)</div><div class="line"></div><div class="line">        <span class="comment"># Note that P6 is used in RPN, but not in the classifier heads.</span></div><div class="line">        rpn_feature_maps = [P2, P3, P4, P5, P6]</div><div class="line">        mrcnn_feature_maps = [P2, P3, P4, P5]</div><div class="line"></div><div class="line">        <span class="comment"># Generate Anchors</span></div><div class="line">        self.anchors = utils.generate_pyramid_anchors(config.RPN_ANCHOR_SCALES,</div><div class="line">                                                      config.RPN_ANCHOR_RATIOS,</div><div class="line">                                                      config.BACKBONE_SHAPES,</div><div class="line">                                                      config.BACKBONE_STRIDES,</div><div class="line">                                                      config.RPN_ANCHOR_STRIDE)</div><div class="line"></div><div class="line">        <span class="comment"># RPN Model</span></div><div class="line">        rpn = build_rpn_model(config.RPN_ANCHOR_STRIDE,</div><div class="line">                              len(config.RPN_ANCHOR_RATIOS), <span class="number">256</span>)</div><div class="line">        <span class="comment"># Loop through pyramid layers</span></div><div class="line">        layer_outputs = []  <span class="comment"># list of lists</span></div><div class="line">        <span class="keyword">for</span> p <span class="keyword">in</span> rpn_feature_maps:</div><div class="line">            layer_outputs.append(rpn([p]))</div><div class="line">        <span class="comment"># Concatenate layer outputs</span></div><div class="line">        <span class="comment"># Convert from list of lists of level outputs to list of lists</span></div><div class="line">        <span class="comment"># of outputs across levels.</span></div><div class="line">        <span class="comment"># e.g. [[a1, b1, c1], [a2, b2, c2]] =&gt; [[a1, a2], [b1, b2], [c1, c2]]</span></div><div class="line">        output_names = [<span class="string">"rpn_class_logits"</span>, <span class="string">"rpn_class"</span>, <span class="string">"rpn_bbox"</span>]</div><div class="line">        outputs = list(zip(*layer_outputs))</div><div class="line">        outputs = [KL.Concatenate(axis=<span class="number">1</span>, name=n)(list(o))</div><div class="line">                   <span class="keyword">for</span> o, n <span class="keyword">in</span> zip(outputs, output_names)]</div><div class="line"></div><div class="line">        rpn_class_logits, rpn_class, rpn_bbox = outputs</div><div class="line"></div><div class="line">        <span class="comment"># Generate proposals</span></div><div class="line">        <span class="comment"># Proposals are [batch, N, (y1, x1, y2, x2)] in normalized coordinates</span></div><div class="line">        <span class="comment"># and zero padded.</span></div><div class="line">        proposal_count = config.POST_NMS_ROIS_TRAINING <span class="keyword">if</span> mode == <span class="string">"training"</span>\</div><div class="line">            <span class="keyword">else</span> config.POST_NMS_ROIS_INFERENCE</div><div class="line">        rpn_rois = ProposalLayer(proposal_count=proposal_count,</div><div class="line">                                 nms_threshold=config.RPN_NMS_THRESHOLD,</div><div class="line">                                 name=<span class="string">"ROI"</span>,</div><div class="line">                                 anchors=self.anchors,</div><div class="line">                                 config=config)([rpn_class, rpn_bbox])</div><div class="line"></div><div class="line">        <span class="keyword">if</span> mode == <span class="string">"training"</span>:</div><div class="line">            <span class="comment"># Class ID mask to mark class IDs supported by the dataset the image</span></div><div class="line">            <span class="comment"># came from.</span></div><div class="line">            _, _, _, active_class_ids = KL.Lambda(<span class="keyword">lambda</span> x: parse_image_meta_graph(x),</div><div class="line">                                                  mask=[<span class="keyword">None</span>, <span class="keyword">None</span>, <span class="keyword">None</span>, <span class="keyword">None</span>])(input_image_meta)</div><div class="line"></div><div class="line">            <span class="keyword">if</span> <span class="keyword">not</span> config.USE_RPN_ROIS:</div><div class="line">                <span class="comment"># Ignore predicted ROIs and use ROIs provided as an input.</span></div><div class="line">                input_rois = KL.Input(shape=[config.POST_NMS_ROIS_TRAINING, <span class="number">4</span>],</div><div class="line">                                      name=<span class="string">"input_roi"</span>, dtype=np.int32)</div><div class="line">                <span class="comment"># Normalize coordinates to 0-1 range.</span></div><div class="line">                target_rois = KL.Lambda(<span class="keyword">lambda</span> x: K.cast(</div><div class="line">                    x, tf.float32) / image_scale[:<span class="number">4</span>])(input_rois)</div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                target_rois = rpn_rois</div><div class="line"></div><div class="line">            <span class="comment"># Generate detection targets</span></div><div class="line">            <span class="comment"># Subsamples proposals and generates target outputs for training</span></div><div class="line">            <span class="comment"># Note that proposal class IDs, gt_boxes, and gt_masks are zero</span></div><div class="line">            <span class="comment"># padded. Equally, returned rois and targets are zero padded.</span></div><div class="line">            rois, target_class_ids, target_bbox, target_mask =\</div><div class="line">                DetectionTargetLayer(config, name=<span class="string">"proposal_targets"</span>)([</div><div class="line">                    target_rois, input_gt_class_ids, gt_boxes, input_gt_masks])</div><div class="line"></div><div class="line">            <span class="comment"># Network Heads</span></div><div class="line">            <span class="comment"># <span class="doctag">TODO:</span> verify that this handles zero padded ROIs</span></div><div class="line">            mrcnn_class_logits, mrcnn_class, mrcnn_bbox =\</div><div class="line">                fpn_classifier_graph(rois, mrcnn_feature_maps, config.IMAGE_SHAPE,</div><div class="line">                                     config.POOL_SIZE, config.NUM_CLASSES)</div><div class="line"></div><div class="line">            mrcnn_mask = build_fpn_mask_graph(rois, mrcnn_feature_maps,</div><div class="line">                                              config.IMAGE_SHAPE,</div><div class="line">                                              config.MASK_POOL_SIZE,</div><div class="line">                                              config.NUM_CLASSES)</div><div class="line"></div><div class="line">            <span class="comment"># <span class="doctag">TODO:</span> clean up (use tf.identify if necessary)</span></div><div class="line">            output_rois = KL.Lambda(<span class="keyword">lambda</span> x: x * <span class="number">1</span>, name=<span class="string">"output_rois"</span>)(rois)</div><div class="line"></div><div class="line">            <span class="comment"># Losses</span></div><div class="line">            rpn_class_loss = KL.Lambda(<span class="keyword">lambda</span> x: rpn_class_loss_graph(*x), name=<span class="string">"rpn_class_loss"</span>)(</div><div class="line">                [input_rpn_match, rpn_class_logits])</div><div class="line">            rpn_bbox_loss = KL.Lambda(<span class="keyword">lambda</span> x: rpn_bbox_loss_graph(config, *x), name=<span class="string">"rpn_bbox_loss"</span>)(</div><div class="line">                [input_rpn_bbox, input_rpn_match, rpn_bbox])</div><div class="line">            class_loss = KL.Lambda(<span class="keyword">lambda</span> x: mrcnn_class_loss_graph(*x), name=<span class="string">"mrcnn_class_loss"</span>)(</div><div class="line">                [target_class_ids, mrcnn_class_logits, active_class_ids])</div><div class="line">            bbox_loss = KL.Lambda(<span class="keyword">lambda</span> x: mrcnn_bbox_loss_graph(*x), name=<span class="string">"mrcnn_bbox_loss"</span>)(</div><div class="line">                [target_bbox, target_class_ids, mrcnn_bbox])</div><div class="line">            mask_loss = KL.Lambda(<span class="keyword">lambda</span> x: mrcnn_mask_loss_graph(*x), name=<span class="string">"mrcnn_mask_loss"</span>)(</div><div class="line">                [target_mask, target_class_ids, mrcnn_mask])</div><div class="line"></div><div class="line">            <span class="comment"># Model</span></div><div class="line">            inputs = [input_image, input_image_meta,</div><div class="line">                      input_rpn_match, input_rpn_bbox, input_gt_class_ids, input_gt_boxes, input_gt_masks]</div><div class="line">            <span class="keyword">if</span> <span class="keyword">not</span> config.USE_RPN_ROIS:</div><div class="line">                inputs.append(input_rois)</div><div class="line">            outputs = [rpn_class_logits, rpn_class, rpn_bbox,</div><div class="line">                       mrcnn_class_logits, mrcnn_class, mrcnn_bbox, mrcnn_mask,</div><div class="line">                       rpn_rois, output_rois,</div><div class="line">                       rpn_class_loss, rpn_bbox_loss, class_loss, bbox_loss, mask_loss]</div><div class="line">            model = KM.Model(inputs, outputs, name=<span class="string">'mask_rcnn'</span>)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="comment"># Network Heads</span></div><div class="line">            <span class="comment"># Proposal classifier and BBox regressor heads</span></div><div class="line">            mrcnn_class_logits, mrcnn_class, mrcnn_bbox =\</div><div class="line">                fpn_classifier_graph(rpn_rois, mrcnn_feature_maps, config.IMAGE_SHAPE,</div><div class="line">                                     config.POOL_SIZE, config.NUM_CLASSES)</div><div class="line"></div><div class="line">            <span class="comment"># Detections</span></div><div class="line">            <span class="comment"># output is [batch, num_detections, (y1, x1, y2, x2, class_id, score)] in image coordinates</span></div><div class="line">            detections = DetectionLayer(config, name=<span class="string">"mrcnn_detection"</span>)(</div><div class="line">                [rpn_rois, mrcnn_class, mrcnn_bbox, input_image_meta])</div><div class="line"></div><div class="line">            <span class="comment"># Convert boxes to normalized coordinates</span></div><div class="line">            <span class="comment"># <span class="doctag">TODO:</span> let DetectionLayer return normalized coordinates to avoid</span></div><div class="line">            <span class="comment">#       unnecessary conversions</span></div><div class="line">            h, w = config.IMAGE_SHAPE[:<span class="number">2</span>]</div><div class="line">            detection_boxes = KL.Lambda(</div><div class="line">                <span class="keyword">lambda</span> x: x[..., :<span class="number">4</span>] / np.array([h, w, h, w]))(detections)</div><div class="line"></div><div class="line">            <span class="comment"># Create masks for detections</span></div><div class="line">            mrcnn_mask = build_fpn_mask_graph(detection_boxes, mrcnn_feature_maps,</div><div class="line">                                              config.IMAGE_SHAPE,</div><div class="line">                                              config.MASK_POOL_SIZE,</div><div class="line">                                              config.NUM_CLASSES)</div><div class="line"></div><div class="line">            model = KM.Model([input_image, input_image_meta],</div><div class="line">                             [detections, mrcnn_class, mrcnn_bbox,</div><div class="line">                                 mrcnn_mask, rpn_rois, rpn_class, rpn_bbox],</div><div class="line">                             name=<span class="string">'mask_rcnn'</span>)</div><div class="line"></div><div class="line">        <span class="comment"># Add multi-GPU support.</span></div><div class="line">        <span class="keyword">if</span> config.GPU_COUNT &gt; <span class="number">1</span>:</div><div class="line">            <span class="keyword">from</span> parallel_model <span class="keyword">import</span> ParallelModel</div><div class="line">            model = ParallelModel(model, config.GPU_COUNT)</div><div class="line"></div><div class="line">        <span class="keyword">return</span> model</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">find_last</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="string">"""Finds the last checkpoint file of the last trained model in the</span></div><div class="line">        model directory.</div><div class="line">        Returns:</div><div class="line">            log_dir: The directory where events and weights are saved</div><div class="line">            checkpoint_path: the path to the last checkpoint file</div><div class="line">        """</div><div class="line">        <span class="comment"># Get directory names. Each directory corresponds to a model</span></div><div class="line">        dir_names = next(os.walk(self.model_dir))[<span class="number">1</span>]</div><div class="line">        key = self.config.NAME.lower()</div><div class="line">        dir_names = filter(<span class="keyword">lambda</span> f: f.startswith(key), dir_names)</div><div class="line">        dir_names = sorted(dir_names)</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> dir_names:</div><div class="line">            <span class="keyword">return</span> <span class="keyword">None</span>, <span class="keyword">None</span></div><div class="line">        <span class="comment"># Pick last directory</span></div><div class="line">        dir_name = os.path.join(self.model_dir, dir_names[<span class="number">-1</span>])</div><div class="line">        <span class="comment"># Find the last checkpoint</span></div><div class="line">        checkpoints = next(os.walk(dir_name))[<span class="number">2</span>]</div><div class="line">        checkpoints = filter(<span class="keyword">lambda</span> f: f.startswith(<span class="string">"mask_rcnn"</span>), checkpoints)</div><div class="line">        checkpoints = sorted(checkpoints)</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> checkpoints:</div><div class="line">            <span class="keyword">return</span> dir_name, <span class="keyword">None</span></div><div class="line">        checkpoint = os.path.join(dir_name, checkpoints[<span class="number">-1</span>])</div><div class="line">        <span class="keyword">return</span> dir_name, checkpoint</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">load_weights</span><span class="params">(self, filepath, by_name=False, exclude=None)</span>:</span></div><div class="line">        <span class="string">"""Modified version of the correspoding Keras function with</span></div><div class="line">        the addition of multi-GPU support and the ability to exclude</div><div class="line">        some layers from loading.</div><div class="line">        exlude: list of layer names to excluce</div><div class="line">        """</div><div class="line">        <span class="keyword">import</span> h5py</div><div class="line">        <span class="keyword">from</span> keras.engine <span class="keyword">import</span> topology</div><div class="line"></div><div class="line">        <span class="keyword">if</span> exclude:</div><div class="line">            by_name = <span class="keyword">True</span></div><div class="line"></div><div class="line">        <span class="keyword">if</span> h5py <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">            <span class="keyword">raise</span> ImportError(<span class="string">'`load_weights` requires h5py.'</span>)</div><div class="line">        f = h5py.File(filepath, mode=<span class="string">'r'</span>)</div><div class="line">        <span class="keyword">if</span> <span class="string">'layer_names'</span> <span class="keyword">not</span> <span class="keyword">in</span> f.attrs <span class="keyword">and</span> <span class="string">'model_weights'</span> <span class="keyword">in</span> f:</div><div class="line">            f = f[<span class="string">'model_weights'</span>]</div><div class="line"></div><div class="line">        <span class="comment"># In multi-GPU training, we wrap the model. Get layers</span></div><div class="line">        <span class="comment"># of the inner model because they have the weights.</span></div><div class="line">        keras_model = self.keras_model</div><div class="line">        layers = keras_model.inner_model.layers <span class="keyword">if</span> hasattr(keras_model, <span class="string">"inner_model"</span>)\</div><div class="line">            <span class="keyword">else</span> keras_model.layers</div><div class="line"></div><div class="line">        <span class="comment"># Exclude some layers</span></div><div class="line">        <span class="keyword">if</span> exclude:</div><div class="line">            layers = filter(<span class="keyword">lambda</span> l: l.name <span class="keyword">not</span> <span class="keyword">in</span> exclude, layers)</div><div class="line"></div><div class="line">        <span class="keyword">if</span> by_name:</div><div class="line">            topology.load_weights_from_hdf5_group_by_name(f, layers)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            topology.load_weights_from_hdf5_group(f, layers)</div><div class="line">        <span class="keyword">if</span> hasattr(f, <span class="string">'close'</span>):</div><div class="line">            f.close()</div><div class="line"></div><div class="line">        <span class="comment"># Update the log directory</span></div><div class="line">        self.set_log_dir(filepath)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_imagenet_weights</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="string">"""Downloads ImageNet trained weights from Keras.</span></div><div class="line">        Returns path to weights file.</div><div class="line">        """</div><div class="line">        <span class="keyword">from</span> keras.utils.data_utils <span class="keyword">import</span> get_file</div><div class="line">        TF_WEIGHTS_PATH_NO_TOP = <span class="string">'https://github.com/fchollet/deep-learning-models/'</span>\</div><div class="line">                                 <span class="string">'releases/download/v0.2/'</span>\</div><div class="line">                                 <span class="string">'resnet50_weights_tf_dim_ordering_tf_kernels_notop.h5'</span></div><div class="line">        weights_path = get_file(<span class="string">'resnet50_weights_tf_dim_ordering_tf_kernels_notop.h5'</span>,</div><div class="line">                                TF_WEIGHTS_PATH_NO_TOP,</div><div class="line">                                cache_subdir=<span class="string">'models'</span>,</div><div class="line">                                md5_hash=<span class="string">'a268eb855778b3df3c7506639542a6af'</span>)</div><div class="line">        <span class="keyword">return</span> weights_path</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">compile</span><span class="params">(self, learning_rate, momentum)</span>:</span></div><div class="line">        <span class="string">"""Gets the model ready for training. Adds losses, regularization, and</span></div><div class="line">        metrics. Then calls the Keras compile() function.</div><div class="line">        """</div><div class="line">        <span class="comment"># Optimizer object</span></div><div class="line">        optimizer = keras.optimizers.SGD(lr=learning_rate, momentum=momentum,</div><div class="line">                                         clipnorm=self.config.GRADIENT_CLIP_NORM)</div><div class="line">        <span class="comment"># Add Losses</span></div><div class="line">        <span class="comment"># First, clear previously set losses to avoid duplication</span></div><div class="line">        self.keras_model._losses = []</div><div class="line">        self.keras_model._per_input_losses = &#123;&#125;</div><div class="line">        loss_names = [<span class="string">"rpn_class_loss"</span>, <span class="string">"rpn_bbox_loss"</span>,</div><div class="line">                      <span class="string">"mrcnn_class_loss"</span>, <span class="string">"mrcnn_bbox_loss"</span>, <span class="string">"mrcnn_mask_loss"</span>]</div><div class="line">        <span class="keyword">for</span> name <span class="keyword">in</span> loss_names:</div><div class="line">            layer = self.keras_model.get_layer(name)</div><div class="line">            <span class="keyword">if</span> layer.output <span class="keyword">in</span> self.keras_model.losses:</div><div class="line">                <span class="keyword">continue</span></div><div class="line">            self.keras_model.add_loss(</div><div class="line">                tf.reduce_mean(layer.output, keep_dims=<span class="keyword">True</span>))</div><div class="line"></div><div class="line">        <span class="comment"># Add L2 Regularization</span></div><div class="line">        <span class="comment"># Skip gamma and beta weights of batch normalization layers.</span></div><div class="line">        reg_losses = [keras.regularizers.l2(self.config.WEIGHT_DECAY)(w) / tf.cast(tf.size(w), tf.float32)</div><div class="line">                      <span class="keyword">for</span> w <span class="keyword">in</span> self.keras_model.trainable_weights</div><div class="line">                      <span class="keyword">if</span> <span class="string">'gamma'</span> <span class="keyword">not</span> <span class="keyword">in</span> w.name <span class="keyword">and</span> <span class="string">'beta'</span> <span class="keyword">not</span> <span class="keyword">in</span> w.name]</div><div class="line">        self.keras_model.add_loss(tf.add_n(reg_losses))</div><div class="line"></div><div class="line">        <span class="comment"># Compile</span></div><div class="line">        self.keras_model.compile(optimizer=optimizer, loss=[</div><div class="line">                                 <span class="keyword">None</span>] * len(self.keras_model.outputs))</div><div class="line"></div><div class="line">        <span class="comment"># Add metrics for losses</span></div><div class="line">        <span class="keyword">for</span> name <span class="keyword">in</span> loss_names:</div><div class="line">            <span class="keyword">if</span> name <span class="keyword">in</span> self.keras_model.metrics_names:</div><div class="line">                <span class="keyword">continue</span></div><div class="line">            layer = self.keras_model.get_layer(name)</div><div class="line">            self.keras_model.metrics_names.append(name)</div><div class="line">            self.keras_model.metrics_tensors.append(tf.reduce_mean(</div><div class="line">                layer.output, keep_dims=<span class="keyword">True</span>))</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_trainable</span><span class="params">(self, layer_regex, keras_model=None, indent=<span class="number">0</span>, verbose=<span class="number">1</span>)</span>:</span></div><div class="line">        <span class="string">"""Sets model layers as trainable if their names match</span></div><div class="line">        the given regular expression.</div><div class="line">        """</div><div class="line">        <span class="comment"># Print message on the first call (but not on recursive calls)</span></div><div class="line">        <span class="keyword">if</span> verbose &gt; <span class="number">0</span> <span class="keyword">and</span> keras_model <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">            log(<span class="string">"Selecting layers to train"</span>)</div><div class="line"></div><div class="line">        keras_model = keras_model <span class="keyword">or</span> self.keras_model</div><div class="line"></div><div class="line">        <span class="comment"># In multi-GPU training, we wrap the model. Get layers</span></div><div class="line">        <span class="comment"># of the inner model because they have the weights.</span></div><div class="line">        layers = keras_model.inner_model.layers <span class="keyword">if</span> hasattr(keras_model, <span class="string">"inner_model"</span>)\</div><div class="line">            <span class="keyword">else</span> keras_model.layers</div><div class="line"></div><div class="line">        <span class="keyword">for</span> layer <span class="keyword">in</span> layers:</div><div class="line">            <span class="comment"># Is the layer a model?</span></div><div class="line">            <span class="keyword">if</span> layer.__class__.__name__ == <span class="string">'Model'</span>:</div><div class="line">                print(<span class="string">"In model: "</span>, layer.name)</div><div class="line">                self.set_trainable(</div><div class="line">                    layer_regex, keras_model=layer, indent=indent + <span class="number">4</span>)</div><div class="line">                <span class="keyword">continue</span></div><div class="line"></div><div class="line">            <span class="keyword">if</span> <span class="keyword">not</span> layer.weights:</div><div class="line">                <span class="keyword">continue</span></div><div class="line">            <span class="comment"># Is it trainable?</span></div><div class="line">            trainable = bool(re.fullmatch(layer_regex, layer.name))</div><div class="line">            <span class="comment"># Update layer. If layer is a container, update inner layer.</span></div><div class="line">            <span class="keyword">if</span> layer.__class__.__name__ == <span class="string">'TimeDistributed'</span>:</div><div class="line">                layer.layer.trainable = trainable</div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                layer.trainable = trainable</div><div class="line">            <span class="comment"># Print trainble layer names</span></div><div class="line">            <span class="keyword">if</span> trainable <span class="keyword">and</span> verbose &gt; <span class="number">0</span>:</div><div class="line">                log(<span class="string">"&#123;&#125;&#123;:20&#125;   (&#123;&#125;)"</span>.format(<span class="string">" "</span> * indent, layer.name,</div><div class="line">                                            layer.__class__.__name__))</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_log_dir</span><span class="params">(self, model_path=None)</span>:</span></div><div class="line">        <span class="string">"""Sets the model log directory and epoch counter.</span></div><div class="line"></div><div class="line">        model_path: If None, or a format different from what this code uses</div><div class="line">            then set a new log directory and start epochs from 0. Otherwise,</div><div class="line">            extract the log directory and the epoch counter from the file</div><div class="line">            name.</div><div class="line">        """</div><div class="line">        <span class="comment"># Set date and epoch counter as if starting a new model</span></div><div class="line">        self.epoch = <span class="number">0</span></div><div class="line">        now = datetime.datetime.now()</div><div class="line"></div><div class="line">        <span class="comment"># If we have a model path with date and epochs use them</span></div><div class="line">        <span class="keyword">if</span> model_path:</div><div class="line">            <span class="comment"># Continue from we left of. Get epoch and date from the file name</span></div><div class="line">            <span class="comment"># A sample model path might look like:</span></div><div class="line">            <span class="comment"># /path/to/logs/coco20171029T2315/mask_rcnn_coco_0001.h5</span></div><div class="line">            regex = <span class="string">r".*/\w+(\d&#123;4&#125;)(\d&#123;2&#125;)(\d&#123;2&#125;)T(\d&#123;2&#125;)(\d&#123;2&#125;)/mask\_rcnn\_\w+(\d&#123;4&#125;)\.h5"</span></div><div class="line">            m = re.match(regex, model_path)</div><div class="line">            <span class="keyword">if</span> m:</div><div class="line">                now = datetime.datetime(int(m.group(<span class="number">1</span>)), int(m.group(<span class="number">2</span>)), int(m.group(<span class="number">3</span>)),</div><div class="line">                                        int(m.group(<span class="number">4</span>)), int(m.group(<span class="number">5</span>)))</div><div class="line">                self.epoch = int(m.group(<span class="number">6</span>)) + <span class="number">1</span></div><div class="line"></div><div class="line">        <span class="comment"># Directory for training logs</span></div><div class="line">        self.log_dir = os.path.join(self.model_dir, <span class="string">"&#123;&#125;&#123;:%Y%m%dT%H%M&#125;"</span>.format(</div><div class="line">            self.config.NAME.lower(), now))</div><div class="line"></div><div class="line">        <span class="comment"># Path to save after each epoch. Include placeholders that get filled by Keras.</span></div><div class="line">        self.checkpoint_path = os.path.join(self.log_dir, <span class="string">"mask_rcnn_&#123;&#125;_*epoch*.h5"</span>.format(</div><div class="line">            self.config.NAME.lower()))</div><div class="line">        self.checkpoint_path = self.checkpoint_path.replace(</div><div class="line">            <span class="string">"*epoch*"</span>, <span class="string">"&#123;epoch:04d&#125;"</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">train</span><span class="params">(self, train_dataset, val_dataset, learning_rate, epochs, layers,</span></span></div><div class="line">              augmentation=None):</div><div class="line">        <span class="string">"""Train the model.</span></div><div class="line">        train_dataset, val_dataset: Training and validation Dataset objects.</div><div class="line">        learning_rate: The learning rate to train with</div><div class="line">        epochs: Number of training epochs. Note that previous training epochs</div><div class="line">                are considered to be done alreay, so this actually determines</div><div class="line">                the epochs to train in total rather than in this particaular</div><div class="line">                call.</div><div class="line">        layers: Allows selecting wich layers to train. It can be:</div><div class="line">            - A regular expression to match layer names to train</div><div class="line">            - One of these predefined values:</div><div class="line">              heaads: The RPN, classifier and mask heads of the network</div><div class="line">              all: All the layers</div><div class="line">              3+: Train Resnet stage 3 and up</div><div class="line">              4+: Train Resnet stage 4 and up</div><div class="line">              5+: Train Resnet stage 5 and up</div><div class="line">        augmentation: Optional. An imgaug (https://github.com/aleju/imgaug) augmentation.</div><div class="line">            For example, passing imgaug.augmenters.Fliplr(0.5) flips images</div><div class="line">            right/left 50% of the time.</div><div class="line">        """</div><div class="line">        <span class="keyword">assert</span> self.mode == <span class="string">"training"</span>, <span class="string">"Create model in training mode."</span></div><div class="line"></div><div class="line">        <span class="comment"># Pre-defined layer regular expressions</span></div><div class="line">        layer_regex = &#123;</div><div class="line">            <span class="comment"># all layers but the backbone</span></div><div class="line">            <span class="string">"heads"</span>: <span class="string">r"(mrcnn\_.*)|(rpn\_.*)|(fpn\_.*)"</span>,</div><div class="line">            <span class="comment"># From a specific Resnet stage and up</span></div><div class="line">            <span class="string">"3+"</span>: <span class="string">r"(res3.*)|(bn3.*)|(res4.*)|(bn4.*)|(res5.*)|(bn5.*)|(mrcnn\_.*)|(rpn\_.*)|(fpn\_.*)"</span>,</div><div class="line">            <span class="string">"4+"</span>: <span class="string">r"(res4.*)|(bn4.*)|(res5.*)|(bn5.*)|(mrcnn\_.*)|(rpn\_.*)|(fpn\_.*)"</span>,</div><div class="line">            <span class="string">"5+"</span>: <span class="string">r"(res5.*)|(bn5.*)|(mrcnn\_.*)|(rpn\_.*)|(fpn\_.*)"</span>,</div><div class="line">            <span class="comment"># All layers</span></div><div class="line">            <span class="string">"all"</span>: <span class="string">".*"</span>,</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> layers <span class="keyword">in</span> layer_regex.keys():</div><div class="line">            layers = layer_regex[layers]</div><div class="line"></div><div class="line">        <span class="comment"># Data generators</span></div><div class="line">        train_generator = data_generator(train_dataset, self.config, shuffle=<span class="keyword">True</span>,</div><div class="line">                                         augmentation=augmentation,</div><div class="line">                                         batch_size=self.config.BATCH_SIZE)</div><div class="line">        val_generator = data_generator(val_dataset, self.config, shuffle=<span class="keyword">True</span>,</div><div class="line">                                       batch_size=self.config.BATCH_SIZE)</div><div class="line"></div><div class="line">        <span class="comment"># Callbacks</span></div><div class="line">        callbacks = [</div><div class="line">            keras.callbacks.TensorBoard(log_dir=self.log_dir,</div><div class="line">                                        histogram_freq=<span class="number">0</span>, write_graph=<span class="keyword">True</span>, write_images=<span class="keyword">False</span>),</div><div class="line">            keras.callbacks.ModelCheckpoint(self.checkpoint_path,</div><div class="line">                                            verbose=<span class="number">0</span>, save_weights_only=<span class="keyword">True</span>),</div><div class="line">        ]</div><div class="line"></div><div class="line">        <span class="comment"># Train</span></div><div class="line">        log(<span class="string">"\nStarting at epoch &#123;&#125;. LR=&#123;&#125;\n"</span>.format(self.epoch, learning_rate))</div><div class="line">        log(<span class="string">"Checkpoint Path: &#123;&#125;"</span>.format(self.checkpoint_path))</div><div class="line">        self.set_trainable(layers)</div><div class="line">        self.compile(learning_rate, self.config.LEARNING_MOMENTUM)</div><div class="line"></div><div class="line">        <span class="comment"># Work-around for Windows: Keras fails on Windows when using</span></div><div class="line">        <span class="comment"># multiprocessing workers. See discussion here:</span></div><div class="line">        <span class="comment"># https://github.com/matterport/Mask_RCNN/issues/13#issuecomment-353124009</span></div><div class="line">        <span class="keyword">if</span> os.name <span class="keyword">is</span> <span class="string">'nt'</span>:</div><div class="line">            workers = <span class="number">0</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            workers = multiprocessing.cpu_count()</div><div class="line"></div><div class="line">        self.keras_model.fit_generator(</div><div class="line">            train_generator,</div><div class="line">            initial_epoch=self.epoch,</div><div class="line">            epochs=epochs,</div><div class="line">            steps_per_epoch=self.config.STEPS_PER_EPOCH,</div><div class="line">            callbacks=callbacks,</div><div class="line">            validation_data=val_generator,</div><div class="line">            validation_steps=self.config.VALIDATION_STEPS,</div><div class="line">            max_queue_size=<span class="number">100</span>,</div><div class="line">            workers=workers,</div><div class="line">            use_multiprocessing=<span class="keyword">True</span>,</div><div class="line">        )</div><div class="line">        self.epoch = max(self.epoch, epochs)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mold_inputs</span><span class="params">(self, images)</span>:</span></div><div class="line">        <span class="string">"""Takes a list of images and modifies them to the format expected</span></div><div class="line">        as an input to the neural network.</div><div class="line">        images: List of image matricies [height,width,depth]. Images can have</div><div class="line">            different sizes.</div><div class="line"></div><div class="line">        Returns 3 Numpy matricies:</div><div class="line">        molded_images: [N, h, w, 3]. Images resized and normalized.</div><div class="line">        image_metas: [N, length of meta data]. Details about each image.</div><div class="line">        windows: [N, (y1, x1, y2, x2)]. The portion of the image that has the</div><div class="line">            original image (padding excluded).</div><div class="line">        """</div><div class="line">        molded_images = []</div><div class="line">        image_metas = []</div><div class="line">        windows = []</div><div class="line">        <span class="keyword">for</span> image <span class="keyword">in</span> images:</div><div class="line">            <span class="comment"># Resize image to fit the model expected size</span></div><div class="line">            <span class="comment"># <span class="doctag">TODO:</span> move resizing to mold_image()</span></div><div class="line">            molded_image, window, scale, padding = utils.resize_image(</div><div class="line">                image,</div><div class="line">                min_dim=self.config.IMAGE_MIN_DIM,</div><div class="line">                max_dim=self.config.IMAGE_MAX_DIM,</div><div class="line">                padding=self.config.IMAGE_PADDING)</div><div class="line">            molded_image = mold_image(molded_image, self.config)</div><div class="line">            <span class="comment"># Build image_meta</span></div><div class="line">            image_meta = compose_image_meta(</div><div class="line">                <span class="number">0</span>, image.shape, window,</div><div class="line">                np.zeros([self.config.NUM_CLASSES], dtype=np.int32))</div><div class="line">            <span class="comment"># Append</span></div><div class="line">            molded_images.append(molded_image)</div><div class="line">            windows.append(window)</div><div class="line">            image_metas.append(image_meta)</div><div class="line">        <span class="comment"># Pack into arrays</span></div><div class="line">        molded_images = np.stack(molded_images)</div><div class="line">        image_metas = np.stack(image_metas)</div><div class="line">        windows = np.stack(windows)</div><div class="line">        <span class="keyword">return</span> molded_images, image_metas, windows</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">unmold_detections</span><span class="params">(self, detections, mrcnn_mask, image_shape, window)</span>:</span></div><div class="line">        <span class="string">"""Reformats the detections of one image from the format of the neural</span></div><div class="line">        network output to a format suitable for use in the rest of the</div><div class="line">        application.</div><div class="line"></div><div class="line">        detections: [N, (y1, x1, y2, x2, class_id, score)]</div><div class="line">        mrcnn_mask: [N, height, width, num_classes]</div><div class="line">        image_shape: [height, width, depth] Original size of the image before resizing</div><div class="line">        window: [y1, x1, y2, x2] Box in the image where the real image is</div><div class="line">                excluding the padding.</div><div class="line"></div><div class="line">        Returns:</div><div class="line">        boxes: [N, (y1, x1, y2, x2)] Bounding boxes in pixels</div><div class="line">        class_ids: [N] Integer class IDs for each bounding box</div><div class="line">        scores: [N] Float probability scores of the class_id</div><div class="line">        masks: [height, width, num_instances] Instance masks</div><div class="line">        """</div><div class="line">        <span class="comment"># How many detections do we have?</span></div><div class="line">        <span class="comment"># Detections array is padded with zeros. Find the first class_id == 0.</span></div><div class="line">        zero_ix = np.where(detections[:, <span class="number">4</span>] == <span class="number">0</span>)[<span class="number">0</span>]</div><div class="line">        N = zero_ix[<span class="number">0</span>] <span class="keyword">if</span> zero_ix.shape[<span class="number">0</span>] &gt; <span class="number">0</span> <span class="keyword">else</span> detections.shape[<span class="number">0</span>]</div><div class="line"></div><div class="line">        <span class="comment"># Extract boxes, class_ids, scores, and class-specific masks</span></div><div class="line">        boxes = detections[:N, :<span class="number">4</span>]</div><div class="line">        class_ids = detections[:N, <span class="number">4</span>].astype(np.int32)</div><div class="line">        scores = detections[:N, <span class="number">5</span>]</div><div class="line">        masks = mrcnn_mask[np.arange(N), :, :, class_ids]</div><div class="line"></div><div class="line">        <span class="comment"># Compute scale and shift to translate coordinates to image domain.</span></div><div class="line">        h_scale = image_shape[<span class="number">0</span>] / (window[<span class="number">2</span>] - window[<span class="number">0</span>])</div><div class="line">        w_scale = image_shape[<span class="number">1</span>] / (window[<span class="number">3</span>] - window[<span class="number">1</span>])</div><div class="line">        scale = min(h_scale, w_scale)</div><div class="line">        shift = window[:<span class="number">2</span>]  <span class="comment"># y, x</span></div><div class="line">        scales = np.array([scale, scale, scale, scale])</div><div class="line">        shifts = np.array([shift[<span class="number">0</span>], shift[<span class="number">1</span>], shift[<span class="number">0</span>], shift[<span class="number">1</span>]])</div><div class="line"></div><div class="line">        <span class="comment"># Translate bounding boxes to image domain</span></div><div class="line">        boxes = np.multiply(boxes - shifts, scales).astype(np.int32)</div><div class="line"></div><div class="line">        <span class="comment"># Filter out detections with zero area. Often only happens in early</span></div><div class="line">        <span class="comment"># stages of training when the network weights are still a bit random.</span></div><div class="line">        exclude_ix = np.where(</div><div class="line">            (boxes[:, <span class="number">2</span>] - boxes[:, <span class="number">0</span>]) * (boxes[:, <span class="number">3</span>] - boxes[:, <span class="number">1</span>]) &lt;= <span class="number">0</span>)[<span class="number">0</span>]</div><div class="line">        <span class="keyword">if</span> exclude_ix.shape[<span class="number">0</span>] &gt; <span class="number">0</span>:</div><div class="line">            boxes = np.delete(boxes, exclude_ix, axis=<span class="number">0</span>)</div><div class="line">            class_ids = np.delete(class_ids, exclude_ix, axis=<span class="number">0</span>)</div><div class="line">            scores = np.delete(scores, exclude_ix, axis=<span class="number">0</span>)</div><div class="line">            masks = np.delete(masks, exclude_ix, axis=<span class="number">0</span>)</div><div class="line">            N = class_ids.shape[<span class="number">0</span>]</div><div class="line"></div><div class="line">        <span class="comment"># Resize masks to original image size and set boundary threshold.</span></div><div class="line">        full_masks = []</div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(N):</div><div class="line">            <span class="comment"># Convert neural network mask to full size mask</span></div><div class="line">            full_mask = utils.unmold_mask(masks[i], boxes[i], image_shape)</div><div class="line">            full_masks.append(full_mask)</div><div class="line">        full_masks = np.stack(full_masks, axis=<span class="number">-1</span>)\</div><div class="line">            <span class="keyword">if</span> full_masks <span class="keyword">else</span> np.empty((<span class="number">0</span>,) + masks.shape[<span class="number">1</span>:<span class="number">3</span>])</div><div class="line"></div><div class="line">        <span class="keyword">return</span> boxes, class_ids, scores, full_masks</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">detect</span><span class="params">(self, images, verbose=<span class="number">0</span>)</span>:</span></div><div class="line">        <span class="string">"""Runs the detection pipeline.</span></div><div class="line"></div><div class="line">        images: List of images, potentially of different sizes.</div><div class="line"></div><div class="line">        Returns a list of dicts, one dict per image. The dict contains:</div><div class="line">        rois: [N, (y1, x1, y2, x2)] detection bounding boxes</div><div class="line">        class_ids: [N] int class IDs</div><div class="line">        scores: [N] float probability scores for the class IDs</div><div class="line">        masks: [H, W, N] instance binary masks</div><div class="line">        """</div><div class="line">        <span class="keyword">assert</span> self.mode == <span class="string">"inference"</span>, <span class="string">"Create model in inference mode."</span></div><div class="line">        <span class="keyword">assert</span> len(</div><div class="line">            images) == self.config.BATCH_SIZE, <span class="string">"len(images) must be equal to BATCH_SIZE"</span></div><div class="line"></div><div class="line">        <span class="keyword">if</span> verbose:</div><div class="line">            log(<span class="string">"Processing &#123;&#125; images"</span>.format(len(images)))</div><div class="line">            <span class="keyword">for</span> image <span class="keyword">in</span> images:</div><div class="line">                log(<span class="string">"image"</span>, image)</div><div class="line">        <span class="comment"># Mold inputs to format expected by the neural network</span></div><div class="line">        molded_images, image_metas, windows = self.mold_inputs(images)</div><div class="line">        <span class="keyword">if</span> verbose:</div><div class="line">            log(<span class="string">"molded_images"</span>, molded_images)</div><div class="line">            log(<span class="string">"image_metas"</span>, image_metas)</div><div class="line">        <span class="comment"># Run object detection</span></div><div class="line">        detections, mrcnn_class, mrcnn_bbox, mrcnn_mask, \</div><div class="line">            rois, rpn_class, rpn_bbox =\</div><div class="line">            self.keras_model.predict([molded_images, image_metas], verbose=<span class="number">0</span>)</div><div class="line">        <span class="comment"># Process detections</span></div><div class="line">        results = []</div><div class="line">        <span class="keyword">for</span> i, image <span class="keyword">in</span> enumerate(images):</div><div class="line">            final_rois, final_class_ids, final_scores, final_masks =\</div><div class="line">                self.unmold_detections(detections[i], mrcnn_mask[i],</div><div class="line">                                       image.shape, windows[i])</div><div class="line">            results.append(&#123;</div><div class="line">                <span class="string">"rois"</span>: final_rois,</div><div class="line">                <span class="string">"class_ids"</span>: final_class_ids,</div><div class="line">                <span class="string">"scores"</span>: final_scores,</div><div class="line">                <span class="string">"masks"</span>: final_masks,</div><div class="line">            &#125;)</div><div class="line">        <span class="keyword">return</span> results</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">ancestor</span><span class="params">(self, tensor, name, checked=None)</span>:</span></div><div class="line">        <span class="string">"""Finds the ancestor of a TF tensor in the computation graph.</span></div><div class="line">        tensor: TensorFlow symbolic tensor.</div><div class="line">        name: Name of ancestor tensor to find</div><div class="line">        checked: For internal use. A list of tensors that were already</div><div class="line">                 searched to avoid loops in traversing the graph.</div><div class="line">        """</div><div class="line">        checked = checked <span class="keyword">if</span> checked <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span> <span class="keyword">else</span> []</div><div class="line">        <span class="comment"># Put a limit on how deep we go to avoid very long loops</span></div><div class="line">        <span class="keyword">if</span> len(checked) &gt; <span class="number">500</span>:</div><div class="line">            <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line">        <span class="comment"># Convert name to a regex and allow matching a number prefix</span></div><div class="line">        <span class="comment"># because Keras adds them automatically</span></div><div class="line">        <span class="keyword">if</span> isinstance(name, str):</div><div class="line">            name = re.compile(name.replace(<span class="string">"/"</span>, <span class="string">r"(\_\d+)*/"</span>))</div><div class="line"></div><div class="line">        parents = tensor.op.inputs</div><div class="line">        <span class="keyword">for</span> p <span class="keyword">in</span> parents:</div><div class="line">            <span class="keyword">if</span> p <span class="keyword">in</span> checked:</div><div class="line">                <span class="keyword">continue</span></div><div class="line">            <span class="keyword">if</span> bool(re.fullmatch(name, p.name)):</div><div class="line">                <span class="keyword">return</span> p</div><div class="line">            checked.append(p)</div><div class="line">            a = self.ancestor(p, name, checked)</div><div class="line">            <span class="keyword">if</span> a <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">                <span class="keyword">return</span> a</div><div class="line">        <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">find_trainable_layer</span><span class="params">(self, layer)</span>:</span></div><div class="line">        <span class="string">"""If a layer is encapsulated by another layer, this function</span></div><div class="line">        digs through the encapsulation and returns the layer that holds</div><div class="line">        the weights.</div><div class="line">        """</div><div class="line">        <span class="keyword">if</span> layer.__class__.__name__ == <span class="string">'TimeDistributed'</span>:</div><div class="line">            <span class="keyword">return</span> self.find_trainable_layer(layer.layer)</div><div class="line">        <span class="keyword">return</span> layer</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_trainable_layers</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="string">"""Returns a list of layers that have weights."""</span></div><div class="line">        layers = []</div><div class="line">        <span class="comment"># Loop through all layers</span></div><div class="line">        <span class="keyword">for</span> l <span class="keyword">in</span> self.keras_model.layers:</div><div class="line">            <span class="comment"># If layer is a wrapper, find inner trainable layer</span></div><div class="line">            l = self.find_trainable_layer(l)</div><div class="line">            <span class="comment"># Include layer if it has weights</span></div><div class="line">            <span class="keyword">if</span> l.get_weights():</div><div class="line">                layers.append(l)</div><div class="line">        <span class="keyword">return</span> layers</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run_graph</span><span class="params">(self, images, outputs)</span>:</span></div><div class="line">        <span class="string">"""Runs a sub-set of the computation graph that computes the given</span></div><div class="line">        outputs.</div><div class="line"></div><div class="line">        outputs: List of tuples (name, tensor) to compute. The tensors are</div><div class="line">            symbolic TensorFlow tensors and the names are for easy tracking.</div><div class="line"></div><div class="line">        Returns an ordered dict of results. Keys are the names received in the</div><div class="line">        input and values are Numpy arrays.</div><div class="line">        """</div><div class="line">        model = self.keras_model</div><div class="line"></div><div class="line">        <span class="comment"># Organize desired outputs into an ordered dict</span></div><div class="line">        outputs = OrderedDict(outputs)</div><div class="line">        <span class="keyword">for</span> o <span class="keyword">in</span> outputs.values():</div><div class="line">            <span class="keyword">assert</span> o <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span></div><div class="line"></div><div class="line">        <span class="comment"># Build a Keras function to run parts of the computation graph</span></div><div class="line">        inputs = model.inputs</div><div class="line">        <span class="keyword">if</span> model.uses_learning_phase <span class="keyword">and</span> <span class="keyword">not</span> isinstance(K.learning_phase(), int):</div><div class="line">            inputs += [K.learning_phase()]</div><div class="line">        kf = K.function(model.inputs, list(outputs.values()))</div><div class="line"></div><div class="line">        <span class="comment"># Run inference</span></div><div class="line">        molded_images, image_metas, windows = self.mold_inputs(images)</div><div class="line">        <span class="comment"># <span class="doctag">TODO:</span> support training mode?</span></div><div class="line">        <span class="comment"># if TEST_MODE == "training":</span></div><div class="line">        <span class="comment">#     model_in = [molded_images, image_metas,</span></div><div class="line">        <span class="comment">#                 target_rpn_match, target_rpn_bbox,</span></div><div class="line">        <span class="comment">#                 gt_boxes, gt_masks]</span></div><div class="line">        <span class="comment">#     if not config.USE_RPN_ROIS:</span></div><div class="line">        <span class="comment">#         model_in.append(target_rois)</span></div><div class="line">        <span class="comment">#     if model.uses_learning_phase and not isinstance(K.learning_phase(), int):</span></div><div class="line">        <span class="comment">#         model_in.append(1.)</span></div><div class="line">        <span class="comment">#     outputs_np = kf(model_in)</span></div><div class="line">        <span class="comment"># else:</span></div><div class="line"></div><div class="line">        model_in = [molded_images, image_metas]</div><div class="line">        <span class="keyword">if</span> model.uses_learning_phase <span class="keyword">and</span> <span class="keyword">not</span> isinstance(K.learning_phase(), int):</div><div class="line">            model_in.append(<span class="number">0.</span>)</div><div class="line">        outputs_np = kf(model_in)</div><div class="line"></div><div class="line">        <span class="comment"># Pack the generated Numpy arrays into a a dict and log the results.</span></div><div class="line">        outputs_np = OrderedDict([(k, v)</div><div class="line">                                  <span class="keyword">for</span> k, v <span class="keyword">in</span> zip(outputs.keys(), outputs_np)])</div><div class="line">        <span class="keyword">for</span> k, v <span class="keyword">in</span> outputs_np.items():</div><div class="line">            log(k, v)</div><div class="line">        <span class="keyword">return</span> outputs_np</div></pre></td></tr></table></figure>
<ol>
<li>工具</li>
</ol>
<p>一個是輸出log的function，另一個是去修改batch norm，畢竟這repo是2 or 4，太小了會造成反效果</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">log</span><span class="params">(text, array=None)</span>:</span></div><div class="line">    <span class="string">"""Prints a text message. And, optionally, if a Numpy array is provided it</span></div><div class="line">    prints it's shape, min, and max values.</div><div class="line">    """</div><div class="line">    <span class="keyword">if</span> array <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">        text = text.ljust(<span class="number">25</span>)</div><div class="line">        text += (<span class="string">"shape: &#123;:20&#125;  min: &#123;:10.5f&#125;  max: &#123;:10.5f&#125;"</span>.format(</div><div class="line">            str(array.shape),</div><div class="line">            array.min() <span class="keyword">if</span> array.size <span class="keyword">else</span> <span class="string">""</span>,</div><div class="line">            array.max() <span class="keyword">if</span> array.size <span class="keyword">else</span> <span class="string">""</span>))</div><div class="line">    print(text)</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BatchNorm</span><span class="params">(KL.BatchNormalization)</span>:</span></div><div class="line">    <span class="string">"""Batch Normalization class. Subclasses the Keras BN class and</span></div><div class="line">    hardcodes training=False so the BN layer doesn't update</div><div class="line">    during training.</div><div class="line"></div><div class="line">    Batch normalization has a negative effect on training if batches are small</div><div class="line">    so we disable it here.</div><div class="line">    """</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">call</span><span class="params">(self, inputs, training=None)</span>:</span></div><div class="line">        <span class="keyword">return</span> super(self.__class__, self).call(inputs, training=<span class="keyword">False</span>)</div></pre></td></tr></table></figure>
<p>4.resnet graph</p>
<p>Resnet All</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">resnet_graph</span><span class="params">(input_image, architecture, stage5=False)</span>:</span>  </div><div class="line">    <span class="keyword">assert</span> architecture <span class="keyword">in</span> [<span class="string">"resnet50"</span>, <span class="string">"resnet101"</span>]  </div><div class="line">    <span class="comment"># Stage 1  </span></div><div class="line">    x = KL.ZeroPadding2D((<span class="number">3</span>, <span class="number">3</span>))(input_image)  </div><div class="line">    x = KL.Conv2D(<span class="number">64</span>, (<span class="number">7</span>, <span class="number">7</span>), strides=(<span class="number">2</span>, <span class="number">2</span>), name=<span class="string">'conv1'</span>, use_bias=<span class="keyword">True</span>)(x)  </div><div class="line">    x = BatchNorm(axis=<span class="number">3</span>, name=<span class="string">'bn_conv1'</span>)(x)  </div><div class="line">    x = KL.Activation(<span class="string">'relu'</span>)(x)  </div><div class="line">    C1 = x = KL.MaxPooling2D((<span class="number">3</span>, <span class="number">3</span>), strides=(<span class="number">2</span>, <span class="number">2</span>), padding=<span class="string">"same"</span>)(x)  </div><div class="line">    <span class="comment"># Stage 2  </span></div><div class="line">    x = conv_block(x, <span class="number">3</span>, [<span class="number">64</span>, <span class="number">64</span>, <span class="number">256</span>], stage=<span class="number">2</span>, block=<span class="string">'a'</span>, strides=(<span class="number">1</span>, <span class="number">1</span>))  </div><div class="line">    x = identity_block(x, <span class="number">3</span>, [<span class="number">64</span>, <span class="number">64</span>, <span class="number">256</span>], stage=<span class="number">2</span>, block=<span class="string">'b'</span>)  </div><div class="line">    C2 = x = identity_block(x, <span class="number">3</span>, [<span class="number">64</span>, <span class="number">64</span>, <span class="number">256</span>], stage=<span class="number">2</span>, block=<span class="string">'c'</span>)  </div><div class="line">    <span class="comment"># Stage 3  </span></div><div class="line">    x = conv_block(x, <span class="number">3</span>, [<span class="number">128</span>, <span class="number">128</span>, <span class="number">512</span>], stage=<span class="number">3</span>, block=<span class="string">'a'</span>)  </div><div class="line">    x = identity_block(x, <span class="number">3</span>, [<span class="number">128</span>, <span class="number">128</span>, <span class="number">512</span>], stage=<span class="number">3</span>, block=<span class="string">'b'</span>)  </div><div class="line">    x = identity_block(x, <span class="number">3</span>, [<span class="number">128</span>, <span class="number">128</span>, <span class="number">512</span>], stage=<span class="number">3</span>, block=<span class="string">'c'</span>)  </div><div class="line">    C3 = x = identity_block(x, <span class="number">3</span>, [<span class="number">128</span>, <span class="number">128</span>, <span class="number">512</span>], stage=<span class="number">3</span>, block=<span class="string">'d'</span>)  </div><div class="line">    <span class="comment"># Stage 4  </span></div><div class="line">    x = conv_block(x, <span class="number">3</span>, [<span class="number">256</span>, <span class="number">256</span>, <span class="number">1024</span>], stage=<span class="number">4</span>, block=<span class="string">'a'</span>)  </div><div class="line">    block_count = &#123;<span class="string">"resnet50"</span>: <span class="number">5</span>, <span class="string">"resnet101"</span>: <span class="number">22</span>&#125;[architecture]  </div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(block_count):  </div><div class="line">        x = identity_block(x, <span class="number">3</span>, [<span class="number">256</span>, <span class="number">256</span>, <span class="number">1024</span>], stage=<span class="number">4</span>, block=chr(<span class="number">98</span> + i))  </div><div class="line">    C4 = x  </div><div class="line">    <span class="comment"># Stage 5  </span></div><div class="line">    <span class="keyword">if</span> stage5:  </div><div class="line">        x = conv_block(x, <span class="number">3</span>, [<span class="number">512</span>, <span class="number">512</span>, <span class="number">2048</span>], stage=<span class="number">5</span>, block=<span class="string">'a'</span>)  </div><div class="line">        x = identity_block(x, <span class="number">3</span>, [<span class="number">512</span>, <span class="number">512</span>, <span class="number">2048</span>], stage=<span class="number">5</span>, block=<span class="string">'b'</span>)  </div><div class="line">        C5 = x = identity_block(x, <span class="number">3</span>, [<span class="number">512</span>, <span class="number">512</span>, <span class="number">2048</span>], stage=<span class="number">5</span>, block=<span class="string">'c'</span>)  </div><div class="line">    <span class="keyword">else</span>:  </div><div class="line">        C5 = <span class="keyword">None</span>  </div><div class="line">    <span class="keyword">return</span> [C1, C2, C3, C4, C5]</div></pre></td></tr></table></figure>
<p>Convolution</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">ef conv_block(input_tensor, kernel_size, filters, stage, block,</div><div class="line">               strides=(<span class="number">2</span>, <span class="number">2</span>), use_bias=<span class="keyword">True</span>):</div><div class="line">    <span class="string">"""conv_block is the block that has a conv layer at shortcut</span></div><div class="line">    # Arguments</div><div class="line">        input_tensor: input tensor</div><div class="line">        kernel_size: defualt 3, the kernel size of middle conv layer at main path</div><div class="line">        filters: list of integers, the nb_filters of 3 conv layer at main path</div><div class="line">        stage: integer, current stage label, used for generating layer names</div><div class="line">        block: 'a','b'..., current block label, used for generating layer names</div><div class="line">    Note that from stage 3, the first conv layer at main path is with subsample=(2,2)</div><div class="line">    And the shortcut should have subsample=(2,2) as well</div><div class="line">    """</div><div class="line">    nb_filter1, nb_filter2, nb_filter3 = filters</div><div class="line">    conv_name_base = <span class="string">'res'</span> + str(stage) + block + <span class="string">'_branch'</span></div><div class="line">    bn_name_base = <span class="string">'bn'</span> + str(stage) + block + <span class="string">'_branch'</span></div><div class="line"></div><div class="line">    x = KL.Conv2D(nb_filter1, (<span class="number">1</span>, <span class="number">1</span>), strides=strides,</div><div class="line">                  name=conv_name_base + <span class="string">'2a'</span>, use_bias=use_bias)(input_tensor)</div><div class="line">    x = BatchNorm(axis=<span class="number">3</span>, name=bn_name_base + <span class="string">'2a'</span>)(x)</div><div class="line">    x = KL.Activation(<span class="string">'relu'</span>)(x)</div><div class="line"></div><div class="line">    x = KL.Conv2D(nb_filter2, (kernel_size, kernel_size), padding=<span class="string">'same'</span>,</div><div class="line">                  name=conv_name_base + <span class="string">'2b'</span>, use_bias=use_bias)(x)</div><div class="line">    x = BatchNorm(axis=<span class="number">3</span>, name=bn_name_base + <span class="string">'2b'</span>)(x)</div><div class="line">    x = KL.Activation(<span class="string">'relu'</span>)(x)</div><div class="line"></div><div class="line">    x = KL.Conv2D(nb_filter3, (<span class="number">1</span>, <span class="number">1</span>), name=conv_name_base +</div><div class="line">                  <span class="string">'2c'</span>, use_bias=use_bias)(x)</div><div class="line">    x = BatchNorm(axis=<span class="number">3</span>, name=bn_name_base + <span class="string">'2c'</span>)(x)</div><div class="line"></div><div class="line">    shortcut = KL.Conv2D(nb_filter3, (<span class="number">1</span>, <span class="number">1</span>), strides=strides,</div><div class="line">                         name=conv_name_base + <span class="string">'1'</span>, use_bias=use_bias)(input_tensor)</div><div class="line">    shortcut = BatchNorm(axis=<span class="number">3</span>, name=bn_name_base + <span class="string">'1'</span>)(shortcut)</div><div class="line"></div><div class="line">    x = KL.Add()([x, shortcut])</div><div class="line">    x = KL.Activation(<span class="string">'relu'</span>, name=<span class="string">'res'</span> + str(stage) + block + <span class="string">'_out'</span>)(x)</div><div class="line">    <span class="keyword">return</span> x</div></pre></td></tr></table></figure>
<p>Identity Block</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">identity_block</span><span class="params">(input_tensor, kernel_size, filters, stage, block,</span></span></div><div class="line">                   use_bias=True):</div><div class="line">    <span class="string">"""The identity_block is the block that has no conv layer at shortcut</span></div><div class="line">    # Arguments</div><div class="line">        input_tensor: input tensor</div><div class="line">        kernel_size: defualt 3, the kernel size of middle conv layer at main path</div><div class="line">        filters: list of integers, the nb_filters of 3 conv layer at main path</div><div class="line">        stage: integer, current stage label, used for generating layer names</div><div class="line">        block: 'a','b'..., current block label, used for generating layer names</div><div class="line">    """</div><div class="line">    nb_filter1, nb_filter2, nb_filter3 = filters</div><div class="line">    conv_name_base = <span class="string">'res'</span> + str(stage) + block + <span class="string">'_branch'</span></div><div class="line">    bn_name_base = <span class="string">'bn'</span> + str(stage) + block + <span class="string">'_branch'</span></div><div class="line"></div><div class="line">    x = KL.Conv2D(nb_filter1, (<span class="number">1</span>, <span class="number">1</span>), name=conv_name_base + <span class="string">'2a'</span>,</div><div class="line">                  use_bias=use_bias)(input_tensor)</div><div class="line">    x = BatchNorm(axis=<span class="number">3</span>, name=bn_name_base + <span class="string">'2a'</span>)(x)</div><div class="line">    x = KL.Activation(<span class="string">'relu'</span>)(x)</div><div class="line"></div><div class="line">    x = KL.Conv2D(nb_filter2, (kernel_size, kernel_size), padding=<span class="string">'same'</span>,</div><div class="line">                  name=conv_name_base + <span class="string">'2b'</span>, use_bias=use_bias)(x)</div><div class="line">    x = BatchNorm(axis=<span class="number">3</span>, name=bn_name_base + <span class="string">'2b'</span>)(x)</div><div class="line">    x = KL.Activation(<span class="string">'relu'</span>)(x)</div><div class="line"></div><div class="line">    x = KL.Conv2D(nb_filter3, (<span class="number">1</span>, <span class="number">1</span>), name=conv_name_base + <span class="string">'2c'</span>,</div><div class="line">                  use_bias=use_bias)(x)</div><div class="line">    x = BatchNorm(axis=<span class="number">3</span>, name=bn_name_base + <span class="string">'2c'</span>)(x)</div><div class="line"></div><div class="line">    x = KL.Add()([x, input_tensor])</div><div class="line">    x = KL.Activation(<span class="string">'relu'</span>, name=<span class="string">'res'</span> + str(stage) + block + <span class="string">'_out'</span>)(x)</div><div class="line">    <span class="keyword">return</span> x</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://world4jason.github.io/2018/02/06/CapsuleNet/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jason Yeh">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="world4jason">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/02/06/CapsuleNet/" itemprop="url">
                  CapsuleNet
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-02-06T13:53:47+08:00">
                2018-02-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://world4jason.github.io/2018/02/04/untitled-1517723627245/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jason Yeh">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="world4jason">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/02/04/untitled-1517723627245/" itemprop="url">
                  GAN - 手推
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-02-04T13:53:47+08:00">
                2018-02-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Outline"><a href="#Outline" class="headerlink" title="Outline"></a>Outline</h1><ol>
<li>GAN 機率分佈</li>
<li>f-divergence</li>
<li>fenchel conjugate</li>
<li>GAN公式</li>
</ol>
<h1 id="GAN-機率分佈"><a href="#GAN-機率分佈" class="headerlink" title="GAN 機率分佈"></a>GAN 機率分佈</h1><p>機率質量函數(PMF) 可數-&gt;離散<br>機率密度函數(PDF) 不可數-&gt; 不可數</p>
<h4 id="ISSUE-如果換成凹函式呢"><a href="#ISSUE-如果換成凹函式呢" class="headerlink" title="ISSUE 如果換成凹函式呢?"></a>ISSUE 如果換成凹函式呢?</h4><p>-&gt; 大於小於對調 但生成結果好像沒差(?</p>
<p>—未完成 待續</p>
<p>\mathcal {F<em>{i}^{RoI}}</em>{(u^\prime,v^\prime)} = \sum_{(u,v)}^{W \times H} G(u,v;u^\prime, v^\prime|B<em>i) \mathcal F</em>(u,v)</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Jason Yeh" />
          <p class="site-author-name" itemprop="name">Jason Yeh</p>
           
              <p class="site-description motion-element" itemprop="description">菜鳥搬磚日常</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">39</span>
                <span class="site-state-item-name">Artikel</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">15</span>
                <span class="site-state-item-name">Kategorien</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">29</span>
                <span class="site-state-item-name">Tags</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jason Yeh</span>
</div>


<div class="powered-by">
  Erstellt mit  <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config("");
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="custom_mathjax_source">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->



  


  













  





  

  

  

  

</body>
</html>
